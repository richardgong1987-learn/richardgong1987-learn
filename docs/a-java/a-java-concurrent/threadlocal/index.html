<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">ThreadLocal全面解析 | 学习大使</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://richardgong1987-learn.github.io/richardgong1987-learn/docs/a-java/a-java-concurrent/threadlocal"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="ThreadLocal全面解析 | 学习大使"><meta data-react-helmet="true" name="description" content="- 了解ThreadLocal的介绍"><meta data-react-helmet="true" property="og:description" content="- 了解ThreadLocal的介绍"><link data-react-helmet="true" rel="shortcut icon" href="/richardgong1987-learn/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://richardgong1987-learn.github.io/richardgong1987-learn/docs/a-java/a-java-concurrent/threadlocal"><link data-react-helmet="true" rel="alternate" href="https://richardgong1987-learn.github.io/richardgong1987-learn/docs/a-java/a-java-concurrent/threadlocal" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://richardgong1987-learn.github.io/richardgong1987-learn/docs/a-java/a-java-concurrent/threadlocal" hreflang="x-default"><link rel="stylesheet" href="/richardgong1987-learn/assets/css/styles.87861f0e.css">
<link rel="preload" href="/richardgong1987-learn/assets/js/runtime~main.355ae127.js" as="script">
<link rel="preload" href="/richardgong1987-learn/assets/js/main.e4c628bc.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/richardgong1987-learn/"><img src="/richardgong1987-learn/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/richardgong1987-learn/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">学习大使</b></a><a class="navbar__item navbar__link navbar__link--active" href="/richardgong1987-learn/docs/a-java/intro">Java架构师</a><a class="navbar__item navbar__link navbar__link--active" href="/richardgong1987-learn/docs/b-rust/intro">Rust架构师</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__link--active" href="/richardgong1987-learn/docs/c-computer/intro">计算机科学</a><a href="https://github.com/richardgong1987-learn/richardgong1987-learn.git" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Java架构师</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/richardgong1987-learn/docs/a-java/intro">Java架构师学习内容目录</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">java并发编程</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/richardgong1987-learn/docs/a-java/a-java-concurrent/intro">Java并发编程</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">concurent</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/richardgong1987-learn/docs/a-java/a-java-concurrent/nio">NIO【网络编程和】</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/richardgong1987-learn/docs/a-java/a-java-concurrent/threadlocal">ThreadLocal全面解析</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">threadpool</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">java-jvm性能调优</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">java服务架构</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">kafka</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">rocketmq</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/richardgong1987-learn/docs/intro">学习大使</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">rust架构师</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">计算机机科学</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>ThreadLocal全面解析</h1></header><ul><li><strong>了解ThreadLocal的介绍</strong> </li><li><strong>掌握ThreadLocal的运用场景</strong></li><li><strong>了解ThreadLocal的内部结构</strong></li><li><strong>了解ThreadLocal的核心方法源码</strong></li><li><strong>了解ThreadLocalMap的源码</strong></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="1-threadlocal介绍"></a>1. ThreadLocal介绍<a class="hash-link" href="#1-threadlocal介绍" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="11-官方介绍"></a>1.1 官方介绍<a class="hash-link" href="#11-官方介绍" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * This class provides thread-local variables.  These variables differ from</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * their normal counterparts in that each thread that accesses one (via its</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@code get} or {@code set} method) has its own, independently initialized</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * copy of the variable.  {@code ThreadLocal} instances are typically private</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * static fields in classes that wish to associate state with a thread (e.g.,</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * a user ID or Transaction ID).</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;For example, the class below generates unique identifiers local to each</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * thread.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * A thread&#x27;s id is assigned the first time it invokes {@code ThreadId.get()}</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * and remains unchanged on subsequent calls.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;pre&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * import java.util.concurrent.atomic.AtomicInteger;</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * public class ThreadId {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     // Atomic integer containing the next thread ID to be assigned</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     private static final AtomicInteger nextId = new AtomicInteger(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     // Thread local variable containing each thread&#x27;s ID</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     private static final ThreadLocal&amp;lt;Integer&amp;gt; threadId =</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *         new ThreadLocal&amp;lt;Integer&amp;gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *             &amp;#64;Override protected Integer initialValue() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                 return nextId.getAndIncrement();</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     };</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     // Returns the current thread&#x27;s unique ID, assigning it if necessary</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     public static int get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *         return threadId.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/pre&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;Each thread holds an implicit reference to its copy of a thread-local</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * variable as long as the thread is alive and the {@code ThreadLocal}</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * instance is accessible; after a thread goes away, all of its copies of</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * thread-local instances are subject to garbage collection (unless other</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * references to these copies exist).</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author  Josh Bloch and Doug Lea</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @since   1.2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ThreadLocal&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	从Java官方文档中的描述：ThreadLocal类用来提供线程内部的局部变量。这种变量在多线程环境下访问（通过get和set方法访问）时能保证各个线程的变量相对独立于其他线程内的变量。ThreadLocal实例通常来说都是private static类型的，用于关联线程和线程上下文。</p><p>   	我们可以得知 ThreadLocal 的作用是：提供线程内的局部变量，不同的线程之间不会相互干扰，这种变量在线程的生命周期内起作用，减少同一个线程内多个函数或组件之间一些公共变量传递的复杂度。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tex"><pre tabindex="0" class="prism-code language-tex codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">总结:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1. 线程并发: 在多线程并发的场景下</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 传递数据: 我们可以通过ThreadLocal在同一线程，不同组件中传递公共变量</span></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 线程隔离: 每个线程的变量都是独立的，不会互相影响</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="12-基本使用"></a>1.2 基本使用<a class="hash-link" href="#12-基本使用" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="121-常用方法"></a>1.2.1 常用方法<a class="hash-link" href="#121-常用方法" title="Direct link to heading">#</a></h4><p>​	在使用之前,我们先来认识几个ThreadLocal的常用方法</p><table><thead><tr><th>方法声明</th><th>描述</th></tr></thead><tbody><tr><td>ThreadLocal()</td><td>创建ThreadLocal对象</td></tr><tr><td>public void set( T value)</td><td>设置当前线程绑定的局部变量</td></tr><tr><td>public T get()</td><td>获取当前线程绑定的局部变量</td></tr><tr><td>public void remove()</td><td>移除当前线程绑定的局部变量</td></tr></tbody></table><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="122-使用案例"></a>1.2.2 使用案例<a class="hash-link" href="#122-使用案例" title="Direct link to heading">#</a></h4><p> 	我们来看下面这个案例	, 感受一下ThreadLocal 线程隔离的特点： </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyDemo {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String getContent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void setContent(String content) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.content = content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyDemo demo = new MyDemo();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 5; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread thread = new Thread(new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    demo.setContent(Thread.currentThread().getName() + &quot;的数据&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(&quot;-----------------------&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + demo.getContent());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread.setName(&quot;线程&quot; + i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>打印结果:</p><p><img alt="1574149020726" src="data:image/png;base64,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"></p><p>​	从结果可以看出多个线程在访问同一个变量的时候出现的异常，线程间的数据没有隔离。下面我们来看下采用 ThreadLocal 的方式来解决这个问题的例子。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyDemo {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static ThreadLocal&lt;String&gt; tl = new ThreadLocal&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String getContent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return tl.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void setContent(String content) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         tl.set(content);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyDemo demo = new MyDemo();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 5; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread thread = new Thread(new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    demo.setContent(Thread.currentThread().getName() + &quot;的数据&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(&quot;-----------------------&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + demo.getContent());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread.setName(&quot;线程&quot; + i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>打印结果: </p><p>​			<img alt="1574149117289" src="data:image/png;base64,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"></p><p>从结果来看，这样很好的解决了多线程之间数据隔离的问题，十分方便。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="13-threadlocal类与synchronized关键字"></a>1.3 ThreadLocal类与synchronized关键字<a class="hash-link" href="#13-threadlocal类与synchronized关键字" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="131-synchronized同步方式"></a>1.3.1 synchronized同步方式<a class="hash-link" href="#131-synchronized同步方式" title="Direct link to heading">#</a></h4><p>​	这里可能有的朋友会觉得在上述例子中我们完全可以通过加锁来实现这个功能。我们首先来看一下用synchronized代码块实现的效果:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class Demo02 {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getContent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setContent(String content) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.content = content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Demo02 demo02 = new Demo02();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 5; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread t = new Thread(){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    synchronized (Demo02.class){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        demo02.setContent(Thread.currentThread().getName() + &quot;的数据&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        System.out.println(&quot;-------------------------------------&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String content = demo02.getContent();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + content);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setName(&quot;线程&quot; + i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>打印结果: </p><p>​			<img alt="1578321788844" src="data:image/png;base64,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"></p><p>​	从结果可以发现, 加锁确实可以解决这个问题，但是在这里我们强调的是线程数据隔离的问题，并不是多线程共享数据的问题, 在这个案例中使用synchronized关键字是不合适的。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="132-threadlocal与synchronized的区别"></a>1.3.2 ThreadLocal与synchronized的区别<a class="hash-link" href="#132-threadlocal与synchronized的区别" title="Direct link to heading">#</a></h4><p>​	虽然ThreadLocal模式与synchronized关键字都用于处理多线程并发访问变量的问题, 不过两者处理问题的角度和思路不同。</p><table><thead><tr><th></th><th>synchronized</th><th>ThreadLocal</th></tr></thead><tbody><tr><td>原理</td><td>同步机制采用&#x27;以时间换空间&#x27;的方式, 只提供了一份变量,让不同的线程排队访问</td><td>ThreadLocal采用&#x27;以空间换时间&#x27;的方式, 为每一个线程都提供了一份变量的副本,从而实现同时访问而相不干扰</td></tr><tr><td>侧重点</td><td>多个线程之间访问资源的同步</td><td>多线程中让每个线程之间的数据相互隔离</td></tr></tbody></table><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tex"><pre tabindex="0" class="prism-code language-tex codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">总结： 在刚刚的案例中，虽然使用ThreadLocal和synchronized都能解决问题,但是使用ThreadLocal更为合适,因为这样可以使程序拥有更高的并发性。</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="2-运用场景_事务案例"></a>2. 运用场景_事务案例<a class="hash-link" href="#2-运用场景_事务案例" title="Direct link to heading">#</a></h2><p>​	通过以上的介绍，我们已经基本了解ThreadLocal的特点。但是它具体是运用在什么场景中呢？ 接下来让我们看一个案例： 事务操作。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="21-转账案例"></a>2.1 转账案例<a class="hash-link" href="#21-转账案例" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="211-场景构建"></a>2.1.1 场景构建<a class="hash-link" href="#211-场景构建" title="Direct link to heading">#</a></h4><p>​	这里我们先构建一个简单的转账场景： 有一个数据表account，里面有两个用户Jack和Rose，用户Jack  给用户Rose 转账。 </p><p>​	案例的实现主要用mysql数据库，JDBC 和 C3P0 框架。以下是详细代码 ： </p><p>​	（1） 项目结构</p><p><img alt="1574045241145" src="/richardgong1987-learn/assets/images/001-e20d5ba40a5987df78480d223727b2b0.png"></p><p>​	（2） 数据准备</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 使用数据库</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> test</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 创建一张账户表</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    id </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">primary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">key</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">auto_increment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    money </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 初始化数据</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">insert</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> account </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Jack&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">insert</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> account </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Rose&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	（3） C3P0配置文件和工具类</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">c3p0-config</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- 使用默认的配置读取连接池对象 --&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">default-config</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!--  连接参数 --&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">driverClass</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.mysql.jdbc.Driver</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">jdbcUrl</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">jdbc:mysql://localhost:3306/test</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">user</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">root</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">password</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1234</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- 连接池参数 --&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">initialPoolSize</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">5</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">maxPoolSize</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">10</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">checkoutTimeout</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">3000</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">default-config</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">c3p0-config</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​    	（4） 工具类 ： JdbcUtils</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.utils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mchange.v2.c3p0.ComboPooledDataSource;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JdbcUtils {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // c3p0 数据库连接池对象属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ComboPooledDataSource ds = new ComboPooledDataSource();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取连接</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Connection getConnection() throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ds.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //释放资源</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void release(AutoCloseable... ios){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (AutoCloseable io : ios) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(io != null){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    io.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void commitAndClose(Connection conn) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(conn != null){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //提交事务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.commit();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //释放连接</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void rollbackAndClose(Connection conn) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(conn != null){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //回滚事务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.rollback();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //释放连接</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	（5） dao层代码 ： AccountDao</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.dao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.utils.JdbcUtils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.PreparedStatement;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountDao {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void out(String outUser, int money) throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money - ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,outUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void in(String inUser, int money) throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money + ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,inUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	（6） service层代码 ： AccountService</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.service;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.dao.AccountDao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean transfer(String outUser, String inUser, int money) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccountDao ad = new AccountDao();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 转出</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.out(outUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 转入</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.in(inUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	（7） web层代码 ： AccountWeb</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.web;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.service.AccountService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountWeb {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 模拟数据 : Jack 给 Rose 转账 100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String outUser = &quot;Jack&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String inUser = &quot;Rose&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int money = 100;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccountService as = new AccountService();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean result = as.transfer(outUser, inUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (result == false) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;转账失败!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;转账成功!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="212-引入事务"></a>2.1.2 引入事务<a class="hash-link" href="#212-引入事务" title="Direct link to heading">#</a></h4><p>​	案例中的转账涉及两个DML操作： 一个转出，一个转入。这些操作是需要具备原子性的，不可分割。不然就有可能出现数据修改异常情况。  </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean transfer(String outUser, String inUser, int money) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccountDao ad = new AccountDao();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 转出</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.out(outUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 模拟转账过程中的异常</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int i = 1/0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 转入</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.in(inUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	所以这里就需要操作事务，来保证转出和转入操作具备原子性，要么同时成功，要么同时失败。</p><p> （1） JDBC中关于事务的操作的api</p><table><thead><tr><th>Connection接口的方法</th><th>作用</th></tr></thead><tbody><tr><td>void  setAutoCommit(false)</td><td>禁用事务自动提交（改为手动）</td></tr><tr><td>void  commit();</td><td>提交事务</td></tr><tr><td>void rollback();</td><td>回滚事务</td></tr></tbody></table><p>  <strong>（2） 开启事务的注意点:</strong></p><ul><li><p>为了保证所有的操作在一个事务中,案例中使用的连接必须是同一个:  service层开启事务的connection需要跟dao层访问数据库的connection保持一致</p></li><li><p>线程并发情况下, 每个线程只能操作各自的 connection</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="22--常规解决方案"></a>2.2  常规解决方案<a class="hash-link" href="#22--常规解决方案" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="221-常规方案的实现"></a>2.2.1 常规方案的实现<a class="hash-link" href="#221-常规方案的实现" title="Direct link to heading">#</a></h4><p>基于上面给出的前提， 大家通常想到的解决方案是 ： </p><ul><li>传参: 从service层将connection对象向dao层传递 </li><li>加锁</li></ul><p>以下是代码实现修改的部分： </p><p>​	（1 ) AccountService 类 </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.service;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.dao.AccountDao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.utils.JdbcUtils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean transfer(String outUser, String inUser, int money) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccountDao ad = new AccountDao();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //线程并发情况下,为了保证每个线程使用各自的connection,故加锁</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (AccountService.class) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //开启事务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.setAutoCommit(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 转出</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ad.out(conn, outUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 模拟转账过程中的异常</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//            int i = 1/0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 转入</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ad.in(conn, inUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //事务提交</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                JdbcUtils.commitAndClose(conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //事务回滚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                JdbcUtils.rollbackAndClose(conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	（2) AccountDao 类 （这里需要注意的是： connection不能在dao层释放，要在service层，不然在dao层释放，service层就无法使用了）</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.dao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.utils.JdbcUtils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.PreparedStatement;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountDao {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void out(Connection conn, String outUser, int money) throws SQLException{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money - ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //注释从连接池获取连接的代码,使用从service中传递过来的connection</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,outUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //连接不能在这里释放,service层中还需要使用</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void in(Connection conn, String inUser, int money) throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money + ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,inUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="222-常规方案的弊端"></a>2.2.2 常规方案的弊端<a class="hash-link" href="#222-常规方案的弊端" title="Direct link to heading">#</a></h4><p>上述方式我们看到的确按要求解决了问题，但是仔细观察，会发现这样实现的弊端： </p><ol><li><p>直接从service层传递connection到dao层, 造成代码耦合度提高</p></li><li><p>加锁会造成线程失去并发性，程序性能降低</p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="23-threadlocal解决方案"></a>2.3 ThreadLocal解决方案<a class="hash-link" href="#23-threadlocal解决方案" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="231-threadlocal方案的实现"></a>2.3.1 ThreadLocal方案的实现<a class="hash-link" href="#231-threadlocal方案的实现" title="Direct link to heading">#</a></h4><p>像这种需要在项目中进行<strong>数据传递</strong>和<strong>线程隔离</strong>的场景，我们不妨用ThreadLocal来解决： </p><p>​	（1） 工具类的修改： 加入ThreadLocal</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.utils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mchange.v2.c3p0.ComboPooledDataSource;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JdbcUtils {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ThreadLocal对象 : 将connection绑定在当前线程中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ThreadLocal&lt;Connection&gt; tl = new ThreadLocal();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // c3p0 数据库连接池对象属性</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ComboPooledDataSource ds = new ComboPooledDataSource();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取连接</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Connection getConnection() throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //取出当前线程绑定的connection对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = tl.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (conn == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //如果没有，则从连接池中取出</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn = ds.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //再将connection对象绑定到当前线程中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            tl.set(conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return conn;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //释放资源</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void release(AutoCloseable... ios) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (AutoCloseable io : ios) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (io != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    io.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void commitAndClose() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //提交事务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.commit();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //解除绑定</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            tl.remove();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //释放连接</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void rollbackAndClose() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //回滚事务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.rollback();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //解除绑定</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            tl.remove();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //释放连接</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	（2） AccountService类的修改：不需要传递connection对象</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.service;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.dao.AccountDao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.utils.JdbcUtils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean transfer(String outUser, String inUser, int money) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccountDao ad = new AccountDao();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //开启事务</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.setAutoCommit(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 转出 ： 这里不需要传参了 ！</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.out(outUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 模拟转账过程中的异常</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//            int i = 1 / 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 转入</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.in(inUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //事务提交</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            JdbcUtils.commitAndClose();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //事务回滚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           JdbcUtils.rollbackAndClose();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	（3） AccountDao类的修改：照常使用</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.dao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.utils.JdbcUtils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.PreparedStatement;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountDao {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void out(String outUser, int money) throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money - ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,outUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //照常使用</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void in(String inUser, int money) throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money + ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,inUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="232-threadlocal方案的好处"></a>2.3.2 ThreadLocal方案的好处<a class="hash-link" href="#232-threadlocal方案的好处" title="Direct link to heading">#</a></h4><p>从上述的案例中我们可以看到， 在一些特定场景下，ThreadLocal方案有两个突出的优势： </p><ol><li><p>传递数据 ： 保存每个线程绑定的数据，在需要的地方可以直接获取, 避免参数直接传递带来的代码耦合问题</p></li><li><p>线程隔离 ： 各线程之间的数据相互隔离却又具备并发性，避免同步方式带来的性能损失</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="3-threadlocal的内部结构"></a>3. ThreadLocal的内部结构<a class="hash-link" href="#3-threadlocal的内部结构" title="Direct link to heading">#</a></h2><p>​	通过以上的学习，我们对ThreadLocal的作用有了一定的认识。现在我们一起来看一下ThreadLocal的内部结构，探究它能够实现线程数据隔离的原理。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="31--常见的误解"></a>3.1  常见的误解<a class="hash-link" href="#31--常见的误解" title="Direct link to heading">#</a></h3><p>​	如果我们不去看源代码的话，可能会猜测<code>ThreadLocal</code>是这样子设计的：每个<code>ThreadLocal</code>都创建一个<code>Map</code>，然后用线程作为<code>Map</code>的<code>key</code>，要存储的局部变量作为<code>Map</code>的<code>value</code>，这样就能达到各个线程的局部变量隔离的效果。这是最简单的设计方法，JDK最早期的<code>ThreadLocal</code> 确实是这样设计的，但现在早已不是了。</p><p><img alt="1582788729557" src="/richardgong1987-learn/assets/images/008-54cdede3f8dbbbc835d89c6111d34b07.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="32--现在的设计"></a>3.2  现在的设计<a class="hash-link" href="#32--现在的设计" title="Direct link to heading">#</a></h3><p>​	但是，JDK后面优化了设计方案，在JDK8中 <code>ThreadLocal</code>的设计是：每个<code>Thread</code>维护一个<code>ThreadLocalMap</code>，这个Map的<code>key</code>是<code>ThreadLocal</code>实例本身，<code>value</code>才是真正要存储的值<code>Object</code>。</p><p>具体的过程是这样的：</p><p>​	（1） 每个Thread线程内部都有一个Map (ThreadLocalMap)
​	（2） Map里面存储ThreadLocal对象（key）和线程的变量副本（value）
​	（3）Thread内部的Map是由ThreadLocal维护的，由ThreadLocal负责向map获取和设置线程的变量值。
​	（4）对于不同的线程，每次获取副本值时，别的线程并不能获取到当前线程的副本值，形成了副本的隔离，互不干扰。	</p><p><img alt="1574155226793" src="/richardgong1987-learn/assets/images/004-2a884ca053576188ab7732799ad25317.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="33-这样设计的好处"></a>3.3 这样设计的好处<a class="hash-link" href="#33-这样设计的好处" title="Direct link to heading">#</a></h3><p>​	这个设计与我们一开始说的设计刚好相反，这样设计有如下两个优势：</p><p>（1） 这样设计之后每个<code>Map</code>存储的<code>Entry</code>数量就会变少。因为之前的存储数量由<code>Thread</code>的数量决定，现在是由<code>ThreadLocal</code>的数量决定。在实际运用当中，往往ThreadLocal的数量要少于Thread的数量。</p><p>（2） 当<code>Thread</code>销毁之后，对应的<code>ThreadLocalMap</code>也会随之销毁，能减少内存的使用。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="4-threadlocal的核心方法源码"></a>4. ThreadLocal的核心方法源码<a class="hash-link" href="#4-threadlocal的核心方法源码" title="Direct link to heading">#</a></h2><p>​	基于ThreadLocal的内部结构，我们继续分析它的核心方法源码，更深入的了解其操作原理。</p><p>除了构造方法之外， ThreadLocal对外暴露的方法有以下4个：</p><table><thead><tr><th>方法声明</th><th>描述</th></tr></thead><tbody><tr><td>protected T initialValue()</td><td>返回当前线程局部变量的初始值</td></tr><tr><td>public void set( T value)</td><td>设置当前线程绑定的局部变量</td></tr><tr><td>public T get()</td><td>获取当前线程绑定的局部变量</td></tr><tr><td>public void remove()</td><td>移除当前线程绑定的局部变量</td></tr></tbody></table><p>​	以下是这4个方法的详细源码分析(为了保证思路清晰, ThreadLocalMap部分暂时不展开,下一个知识点详解)</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="41-set方法"></a>4.1 set方法<a class="hash-link" href="#41-set方法" title="Direct link to heading">#</a></h3><p><strong>（1 ) 源码和对应的中文注释</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 设置当前线程对应的ThreadLocal的值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param value 将要保存在当前线程对应的ThreadLocal的值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void set(T value) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取当前线程对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread t = Thread.currentThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取此线程对象中维护的ThreadLocalMap对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadLocalMap map = getMap(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断map是否存在</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (map != null)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 存在则调用map.set设置此实体entry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.set(this, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1）当前线程Thread 不存在ThreadLocalMap对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2）则调用createMap进行ThreadLocalMap对象的初始化</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3）并将 t(当前线程)和value(t对应的值)作为第一个entry存放至ThreadLocalMap中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            createMap(t, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 获取当前线程Thread对应维护的ThreadLocalMap </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param  t the current thread 当前线程</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the map 对应维护的ThreadLocalMap </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ThreadLocalMap getMap(Thread t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return t.threadLocals;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *创建当前线程Thread对应维护的ThreadLocalMap </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param t 当前线程</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param firstValue 存放到map中第一个entry的值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void createMap(Thread t, T firstValue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //这里的this是调用此方法的threadLocal</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.threadLocals = new ThreadLocalMap(this, firstValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>（2 )  代码执行流程</strong></p><p>​	A. 首先获取当前线程，并根据当前线程获取一个Map</p><p>​	B. 如果获取的Map不为空，则将参数设置到Map中（当前ThreadLocal的引用作为key）</p><p>​	C. 如果Map为空，则给该线程创建 Map，并设置初始值</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="42-get方法"></a>4.2 get方法<a class="hash-link" href="#42-get方法" title="Direct link to heading">#</a></h3><p><strong>（1 ) 源码和对应的中文注释</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 返回当前线程中保存ThreadLocal的值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 如果当前线程没有此ThreadLocal变量，</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 则它会通过调用{@link #initialValue} 方法进行初始化值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 返回当前线程对应此ThreadLocal的值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public T get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取当前线程对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread t = Thread.currentThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取此线程对象中维护的ThreadLocalMap对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadLocalMap map = getMap(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果此map存在</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (map != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 以当前的ThreadLocal 为 key，调用getEntry获取对应的存储实体e</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadLocalMap.Entry e = map.getEntry(this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 对e进行判空 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (e != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 获取存储实体 e 对应的 value值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 即为我们想要的当前线程对应此ThreadLocal的值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                T result = (T)e.value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /*</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            初始化 : 有两种情况有执行当前代码</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            第一种情况: map不存在，表示此线程没有维护的ThreadLocalMap对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            第二种情况: map存在, 但是没有与当前ThreadLocal关联的entry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return setInitialValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 初始化</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the initial value 初始化后的值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private T setInitialValue() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 调用initialValue获取初始化的值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 此方法可以被子类重写, 如果不重写默认返回null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        T value = initialValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取当前线程对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread t = Thread.currentThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取此线程对象中维护的ThreadLocalMap对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadLocalMap map = getMap(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断map是否存在</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (map != null)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 存在则调用map.set设置此实体entry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.set(this, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1）当前线程Thread 不存在ThreadLocalMap对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2）则调用createMap进行ThreadLocalMap对象的初始化</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3）并将 t(当前线程)和value(t对应的值)作为第一个entry存放至ThreadLocalMap中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            createMap(t, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 返回设置的值value</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>（2 )  代码执行流程</strong> </p><p>​	A. 首先获取当前线程, 根据当前线程获取一个Map</p><p>​	B. 如果获取的Map不为空，则在Map中以ThreadLocal的引用作为key来在Map中获取对应的Entry e，否则转到D</p><p>​	C. 如果e不为null，则返回e.value，否则转到D</p><p>​	D. Map为空或者e为空，则通过initialValue函数获取初始值value，然后用ThreadLocal的引用和value作为firstKey和firstValue创建一个新的Map</p><p>总结:  <strong>先获取当前线程的 ThreadLocalMap 变量，如果存在则返回值，不存在则创建并返回初始值。</strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="43-remove方法"></a>4.3 remove方法<a class="hash-link" href="#43-remove方法" title="Direct link to heading">#</a></h3><p><strong>（1 ) 源码和对应的中文注释</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 删除当前线程中保存的ThreadLocal对应的实体entry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     public void remove() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取当前线程对象中维护的ThreadLocalMap对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         ThreadLocalMap m = getMap(Thread.currentThread());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果此map存在</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         if (m != null)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 存在则调用map.remove</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 以当前ThreadLocal为key删除对应的实体entry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             m.remove(this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>（2 )  代码执行流程</strong></p><p>​	A. 首先获取当前线程，并根据当前线程获取一个Map</p><p>​	B. 如果获取的Map不为空，则移除当前ThreadLocal对象对应的entry</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="44-initialvalue方法"></a><strong>4.4 initialValue方法</strong><a class="hash-link" href="#44-initialvalue方法" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * 返回当前线程对应的ThreadLocal的初始值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * 此方法的第一次调用发生在，当线程通过get方法访问此线程的ThreadLocal值时</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * 除非线程先调用了set方法，在这种情况下，initialValue 才不会被这个线程调用。</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * 通常情况下，每个线程最多调用一次这个方法。</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * &lt;p&gt;这个方法仅仅简单的返回null {@code null};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * 如果程序员想ThreadLocal线程局部变量有一个除null以外的初始值，</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * 必须通过子类继承{@code ThreadLocal} 的方式去重写此方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * 通常, 可以通过匿名内部类的方式实现</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * @return 当前ThreadLocal的初始值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected T initialValue() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	此方法的作用是 返回该线程局部变量的初始值。</p><p>（1） 这个方法是一个延迟调用方法，从上面的代码我们得知，在set方法还未调用而先调用了get方法时才执行，并且仅执行1次。</p><p>（2）这个方法缺省实现直接返回一个<code>null</code>。</p><p>（3）如果想要一个除null之外的初始值，可以重写此方法。（备注： 该方法是一个<code>protected</code>的方法，显然是为了让子类覆盖而设计的）</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="5-threadlocalmap源码分析"></a>5. ThreadLocalMap源码分析<a class="hash-link" href="#5-threadlocalmap源码分析" title="Direct link to heading">#</a></h2><p>​	在分析ThreadLocal方法的时候，我们了解到ThreadLocal的操作实际上是围绕ThreadLocalMap展开的。ThreadLocalMap的源码相对比较复杂, 我们从以下三个方面进行讨论。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="51-基本结构"></a>5.1 基本结构<a class="hash-link" href="#51-基本结构" title="Direct link to heading">#</a></h3><p>​	ThreadLocalMap是ThreadLocal的内部类，没有实现Map接口，用独立的方式实现了Map的功能，其内部的Entry也是独立实现。</p><p>   <img alt="1574266262577" src="/richardgong1987-learn/assets/images/005-bd5310f31ddcbbcab43b2327a98d1bd1.png"></p><p><strong>（1） 成员变量</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 初始容量 —— 必须是2的整次幂</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int INITIAL_CAPACITY = 16;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 存放数据的table，Entry类的定义在下面分析</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 同样，数组长度必须是2的整次幂。</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Entry[] table;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 数组里面entrys的个数，可以用于判断table当前使用量是否超过阈值。</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int size = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 进行扩容的阈值，表使用量大于它的时候进行扩容。</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int threshold; // Default to 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	跟HashMap类似，INITIAL_CAPACITY代表这个Map的初始容量；table 是一个Entry 类型的数组，用于存储数据；size 代表表中的存储数目； threshold 代表需要扩容时对应 size 的阈值。</p><p>链接：<a href="https://www.jianshu.com/p/acfd2239c9f4" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/acfd2239c9f4</a></p><p>来源：简书</p><p>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p><strong>（2） 存储结构 - Entry</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Entry继承WeakReference，并且用ThreadLocal作为key.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 如果key为null(entry.get() == null)，意味着key不再被引用，</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 因此这时候entry也可以从table中清除。</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /** The value associated with this ThreadLocal. */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Entry(ThreadLocal&lt;?&gt; k, Object v) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(k);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        value = v;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	 在ThreadLocalMap中，也是用Entry来保存K-V结构数据的。不过Entry中的key只能是ThreadLocal对象，这点在构造方法中已经限定死了。</p><p>​	另外，Entry继承WeakReference，也就是key（ThreadLocal）是弱引用，其目的是将ThreadLocal对象的生命周期和线程生命周期解绑。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="52-弱引用和内存泄漏"></a>5.2 弱引用和内存泄漏<a class="hash-link" href="#52-弱引用和内存泄漏" title="Direct link to heading">#</a></h3><p>​	有些程序员在使用ThreadLocal的过程中会发现有内存泄漏的情况发生，就猜测这个内存泄漏跟Entry中使用了弱引用的key有关系。这个理解其实是不对的。</p><p>​	我们先来回顾这个问题中涉及的几个名词概念，再来分析问题。</p><p>   <strong>（1） 内存泄漏相关概念</strong></p><ul><li>Memory overflow:内存溢出，没有足够的内存提供申请者使用。</li><li>Memory leak: 内存泄漏是指程序中己动态分配的堆内存由于某种原因程序未释放或无法释放，造成系统内存的浪费，导致程序运行速度减慢甚至系统崩溃等严重后果。内存泄漏的堆积终将导致内存溢出。	</li></ul><p><strong>（2）  弱引用相关概念</strong></p><p>​	Java中的引用有4种类型： 强、软、弱、虚。当前这个问题主要涉及到强引用和弱引用：</p><p>​	<strong>强引用（“Strong” Reference）</strong>，就是我们最常见的普通对象引用，只要还有强引用指向一个对象，就能表明对象还“活着”，垃圾回收器就不会回收这种对象。</p><p>​	<strong>弱引用（WeakReference）</strong>，垃圾回收器一旦发现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存。</p><p><strong>（3） 如果key使用强引用</strong></p><p>​	假设ThreadLocalMap中的key使用了强引用，那么会出现内存泄漏吗？</p><p>​	此时ThreadLocal的内存图（实线表示强引用）如下： </p><p><img alt="1582902708234" src="/richardgong1987-learn/assets/images/009-6e8b78b158a71b91f2bb6c7d39d9ac59.png"></p><p>​	假设在业务代码中使用完ThreadLocal ，threadLocal Ref被回收了。</p><p>​	但是因为threadLocalMap的Entry强引用了threadLocal，造成threadLocal无法被回收。</p><p>​	在没有手动删除这个Entry以及CurrentThread依然运行的前提下，始终有强引用链 threadRef-&gt;currentThread-&gt;threadLocalMap-&gt;entry，Entry就不会被回收（Entry中包括了ThreadLocal实例和value），导致Entry内存泄漏。</p><p>​	也就是说，ThreadLocalMap中的key使用了强引用， 是无法完全避免内存泄漏的。</p><p><strong>（5）如果key使用弱引用</strong></p><p>​	那么ThreadLocalMap中的key使用了弱引用，会出现内存泄漏吗？</p><p>​	此时ThreadLocal的内存图（实线表示强引用，虚线表示弱引用）如下： </p><p><img alt="1582907143471" src="/richardgong1987-learn/assets/images/006-8f4acb712ce6ce325bdf8b9384a0f664.png"></p><p>​	</p><p>​	同样假设在业务代码中使用完ThreadLocal ，threadLocal Ref被回收了。</p><p>​	由于ThreadLocalMap只持有ThreadLocal的弱引用，没有任何强引用指向threadlocal实例, 所以threadlocal就可以顺利被gc回收，此时Entry中的key=null。</p><p>​	但是在没有手动删除这个Entry以及CurrentThread依然运行的前提下，也存在有强引用链 threadRef-&gt;currentThread-&gt;threadLocalMap-&gt;entry -&gt; value ，value不会被回收， 而这块value永远不会被访问到了，导致value内存泄漏。</p><p>​	也就是说，ThreadLocalMap中的key使用了弱引用， 也有可能内存泄漏。</p><p><strong>（6）出现内存泄漏的真实原因</strong></p><p>​	比较以上两种情况，我们就会发现，内存泄漏的发生跟ThreadLocalMap中的key是否使用弱引用是没有关系的。那么内存泄漏的的真正原因是什么呢？</p><p>​	细心的同学会发现，在以上两种内存泄漏的情况中，都有两个前提：</p><ol><li>没有手动删除这个Entry</li><li>CurrentThread依然运行</li></ol><p>​        第一点很好理解，只要在使用完ThreadLocal，调用其remove方法删除对应的Entry，就能避免内存泄漏。</p><p>​	第二点稍微复杂一点， 由于ThreadLocalMap是Thread的一个属性，被当前线程所引用，所以它的生命周期跟Thread一样长。那么在使用完ThreadLocal的使用，如果当前Thread也随之执行结束，ThreadLocalMap自然也会被gc回收，从根源上避免了内存泄漏。</p><p>​	综上，<strong>ThreadLocal内存泄漏的根源是</strong>：由于ThreadLocalMap的生命周期跟Thread一样长，如果没有手动删除对应key就会导致内存泄漏。</p><p><strong>（7） 为什么使用弱引用</strong></p><p>​	根据刚才的分析, 我们知道了： 无论ThreadLocalMap中的key使用哪种类型引用都无法完全避免内存泄漏，跟使用弱引用没有关系。</p><p>​	要避免内存泄漏有两种方式：</p><ol><li><p>使用完ThreadLocal，调用其remove方法删除对应的Entry</p></li><li><p>使用完ThreadLocal，当前Thread也随之运行结束</p></li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">相对第一种方式，第二种方式显然更不好控制，特别是使用线程池的时候，线程结束是不会销毁的。</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	也就是说，只要记得在使用完ThreadLocal及时的调用remove，无论key是强引用还是弱引用都不会有问题。那么为什么key要用弱引用呢？</p><p>​	事实上，在ThreadLocalMap中的set/getEntry方法中，会对key为null（也即是ThreadLocal为null）进行判断，如果为null的话，那么是会对value置为null的。</p><p>​	这就意味着使用完ThreadLocal，CurrentThread依然运行的前提下，就算忘记调用remove方法，<strong>弱引用比强引用可以多一层保障</strong>：弱引用的ThreadLocal会被回收，对应的value在下一次ThreadLocalMap调用set,get,remove中的任一方法的时候会被清除，从而避免内存泄漏。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="53-hash冲突的解决"></a>5.3 hash冲突的解决<a class="hash-link" href="#53-hash冲突的解决" title="Direct link to heading">#</a></h3><p>​	hash冲突的解决是Map中的一个重要内容。我们以hash冲突的解决为线索，来研究一下ThreadLocalMap的核心源码。</p><p><strong>（1） 首先从ThreadLocal的set() 方法入手</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  public void set(T value) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread t = Thread.currentThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadLocal.ThreadLocalMap map = getMap(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (map != null)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //调用了ThreadLocalMap的set方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.set(this, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            createMap(t, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ThreadLocal.ThreadLocalMap getMap(Thread t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return t.threadLocals;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void createMap(Thread t, T firstValue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //调用了ThreadLocalMap的构造方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.threadLocals = new ThreadLocal.ThreadLocalMap(this, firstValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>这个方法我们刚才分析过, 其作用是设置当前线程绑定的局部变量 : </p><p>​	A. 首先获取当前线程，并根据当前线程获取一个Map</p><p>​	B. 如果获取的Map不为空，则将参数设置到Map中（当前ThreadLocal的引用作为key）</p><p>​		<strong>(这里调用了ThreadLocalMap的set方法)</strong></p><p>​	C. 如果Map为空，则给该线程创建 Map，并设置初始值</p><p>​		<strong>(这里调用了ThreadLocalMap的构造方法)</strong></p><p>这段代码有两个地方分别涉及到ThreadLocalMap的两个方法, 我们接着分析这两个方法。</p><p><strong>（2）构造方法`ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue)</strong>`</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> /*</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * firstKey : 本ThreadLocal实例(this)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * firstValue ： 要保存的线程本地变量</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //初始化table</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        table = new ThreadLocal.ThreadLocalMap.Entry[INITIAL_CAPACITY];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //计算索引(重点代码）</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //设置值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        table[i] = new ThreadLocal.ThreadLocalMap.Entry(firstKey, firstValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //设置阈值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        setThreshold(INITIAL_CAPACITY);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	构造函数首先创建一个长度为16的Entry数组，然后计算出firstKey对应的索引，然后存储到table中，并设置size和threshold。</p><p>​	<strong>重点分析</strong>： <code>int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1)</code>。</p><p>a. 关于<code>firstKey.threadLocalHashCode</code>：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    private final int threadLocalHashCode = nextHashCode();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static int nextHashCode() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nextHashCode.getAndAdd(HASH_INCREMENT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//AtomicInteger是一个提供原子操作的Integer类，通过线程安全的方式操作加减,适合高并发情况下的使用</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static AtomicInteger nextHashCode =  new AtomicInteger();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //特殊的hash值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int HASH_INCREMENT = 0x61c88647;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	这里定义了一个AtomicInteger类型，每次获取当前值并加上HASH_INCREMENT，<code>HASH_INCREMENT = 0x61c88647</code>,这个值跟斐波那契数列（黄金分割数）有关，其主要目的就是为了让哈希码能均匀的分布在2的n次方的数组里, 也就是Entry[] table中，这样做可以尽量避免hash冲突。</p><p>b. 关于<code>&amp; (INITIAL_CAPACITY - 1)</code></p><p>​	计算hash的时候里面采用了hashCode &amp; (size - 1)的算法，这相当于取模运算hashCode % size的一个更高效的实现。正是因为这种算法，我们要求size必须是2的整次幂，这也能保证在索引不越界的前提下，使得hash发生冲突的次数减小。</p><p><strong>（3） ThreadLocalMap中的set方法</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">private void set(ThreadLocal&lt;?&gt; key, Object value) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadLocal.ThreadLocalMap.Entry[] tab = table;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int len = tab.length;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //计算索引(重点代码，刚才分析过了）</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int i = key.threadLocalHashCode &amp; (len-1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 使用线性探测法查找元素（重点代码）</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ThreadLocal.ThreadLocalMap.Entry e = tab[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             e != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             e = tab[i = nextIndex(i, len)]) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadLocal&lt;?&gt; k = e.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //ThreadLocal 对应的 key 存在，直接覆盖之前的值</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (k == key) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                e.value = value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // key为 null，但是值不为 null，说明之前的 ThreadLocal 对象已经被回收了，</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           // 当前数组中的 Entry 是一个陈旧（stale）的元素</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (k == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //用新元素替换陈旧的元素，这个方法进行了不少的垃圾清理动作，防止内存泄漏</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                replaceStaleEntry(key, value, i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ThreadLocal对应的key不存在并且没有找到陈旧的元素，则在空元素的位置创建一个新的Entry。</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            tab[i] = new Entry(key, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int sz = ++size;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             * cleanSomeSlots用于清除那些e.get()==null的元素，</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             * 这种数据key关联的对象已经被回收，所以这个Entry(table[index])可以被置null。</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             * 如果没有清除任何entry,并且当前使用量达到了负载因子所定义(长度的2/3)，那么进行              * rehash（执行一次全表的扫描清理工作）</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rehash();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 获取环形数组的下一个索引</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static int nextIndex(int i, int len) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ((i + 1 &lt; len) ? i + 1 : 0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>​	代码执行流程：</p><p>A. 首先还是根据key计算出索引 i，然后查找i位置上的Entry，</p><p>B. 若是Entry已经存在并且key等于传入的key，那么这时候直接给这个Entry赋新的value值,</p><p>C. 若是Entry存在，但是key为null，则调用replaceStaleEntry来更换这个key为空的Entry,</p><p>D. 不断循环检测，直到遇到为null的地方，这时候要是还没在循环过程中return，那么就在这个null的位置新建一个Entry，并且插入，同时size增加1。</p><p>​    最后调用cleanSomeSlots，清理key为null的Entry，最后返回是否清理了Entry，接下来再判断sz 是否&gt;= thresgold达到了rehash的条件，达到的话就会调用rehash函数执行一次全表的扫描清理。</p><p><strong>重点分析</strong> ： ThreadLocalMap使用<code>线性探测法</code>来解决哈希冲突的。</p><p>​	该方法一次探测下一个地址，直到有空的地址后插入，若整个空间都找不到空余的地址，则产生溢出。</p><p>​	举个例子，假设当前table长度为16，也就是说如果计算出来key的hash值为14，如果table[14]上已经有值，并且其key与当前key不一致，那么就发生了hash冲突，这个时候将14加1得到15，取table[15]进行判断，这个时候如果还是冲突会回到0，取table[0],以此类推，直到可以插入。</p><p>​	按照上面的描述，可以把Entry[]  table看成一个环形数组。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/richardgong1987-learn/richardgong1987-learn/edit/master/website/docs/a-java/a-java-concurrent/threadlocal.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/richardgong1987-learn/docs/a-java/a-java-concurrent/nio"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« NIO【网络编程和】</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/richardgong1987-learn/docs/a-java/a-java-concurrent/threadpool/readme"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">线程池 »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-threadlocal介绍" class="table-of-contents__link">1. ThreadLocal介绍</a><ul><li><a href="#11-官方介绍" class="table-of-contents__link">1.1 官方介绍</a></li><li><a href="#12-基本使用" class="table-of-contents__link">1.2 基本使用</a></li><li><a href="#13-threadlocal类与synchronized关键字" class="table-of-contents__link">1.3 ThreadLocal类与synchronized关键字</a></li></ul></li><li><a href="#2-运用场景_事务案例" class="table-of-contents__link">2. 运用场景_事务案例</a><ul><li><a href="#21-转账案例" class="table-of-contents__link">2.1 转账案例</a></li><li><a href="#22--常规解决方案" class="table-of-contents__link">2.2  常规解决方案</a></li><li><a href="#23-threadlocal解决方案" class="table-of-contents__link">2.3 ThreadLocal解决方案</a></li></ul></li><li><a href="#3-threadlocal的内部结构" class="table-of-contents__link">3. ThreadLocal的内部结构</a><ul><li><a href="#31--常见的误解" class="table-of-contents__link">3.1  常见的误解</a></li><li><a href="#32--现在的设计" class="table-of-contents__link">3.2  现在的设计</a></li><li><a href="#33-这样设计的好处" class="table-of-contents__link">3.3 这样设计的好处</a></li></ul></li><li><a href="#4-threadlocal的核心方法源码" class="table-of-contents__link">4. ThreadLocal的核心方法源码</a><ul><li><a href="#41-set方法" class="table-of-contents__link">4.1 set方法</a></li><li><a href="#42-get方法" class="table-of-contents__link">4.2 get方法</a></li><li><a href="#43-remove方法" class="table-of-contents__link">4.3 remove方法</a></li><li><a href="#44-initialvalue方法" class="table-of-contents__link"><strong>4.4 initialValue方法</strong></a></li></ul></li><li><a href="#5-threadlocalmap源码分析" class="table-of-contents__link">5. ThreadLocalMap源码分析</a><ul><li><a href="#51-基本结构" class="table-of-contents__link">5.1 基本结构</a></li><li><a href="#52-弱引用和内存泄漏" class="table-of-contents__link">5.2 弱引用和内存泄漏</a></li><li><a href="#53-hash冲突的解决" class="table-of-contents__link">5.3 hash冲突的解决</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/richardgong1987-learn/assets/js/runtime~main.355ae127.js"></script>
<script src="/richardgong1987-learn/assets/js/main.e4c628bc.js"></script>
</body>
</html>