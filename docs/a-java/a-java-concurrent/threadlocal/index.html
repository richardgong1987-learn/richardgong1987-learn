<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">ThreadLocalå…¨é¢è§£æ | å­¦ä¹ å¤§ä½¿</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://richardgong1987-learn.github.io/richardgong1987-learn/docs/a-java/a-java-concurrent/threadlocal"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="ThreadLocalå…¨é¢è§£æ | å­¦ä¹ å¤§ä½¿"><meta data-react-helmet="true" name="description" content="- äº†è§£ThreadLocalçš„ä»‹ç»"><meta data-react-helmet="true" property="og:description" content="- äº†è§£ThreadLocalçš„ä»‹ç»"><link data-react-helmet="true" rel="shortcut icon" href="/richardgong1987-learn/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://richardgong1987-learn.github.io/richardgong1987-learn/docs/a-java/a-java-concurrent/threadlocal"><link data-react-helmet="true" rel="alternate" href="https://richardgong1987-learn.github.io/richardgong1987-learn/docs/a-java/a-java-concurrent/threadlocal" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://richardgong1987-learn.github.io/richardgong1987-learn/docs/a-java/a-java-concurrent/threadlocal" hreflang="x-default"><link rel="stylesheet" href="/richardgong1987-learn/assets/css/styles.87861f0e.css">
<link rel="preload" href="/richardgong1987-learn/assets/js/runtime~main.355ae127.js" as="script">
<link rel="preload" href="/richardgong1987-learn/assets/js/main.e4c628bc.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/richardgong1987-learn/"><img src="/richardgong1987-learn/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/richardgong1987-learn/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">å­¦ä¹ å¤§ä½¿</b></a><a class="navbar__item navbar__link navbar__link--active" href="/richardgong1987-learn/docs/a-java/intro">Javaæ¶æ„å¸ˆ</a><a class="navbar__item navbar__link navbar__link--active" href="/richardgong1987-learn/docs/b-rust/intro">Rustæ¶æ„å¸ˆ</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__link--active" href="/richardgong1987-learn/docs/c-computer/intro">è®¡ç®—æœºç§‘å­¦</a><a href="https://github.com/richardgong1987-learn/richardgong1987-learn.git" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Javaæ¶æ„å¸ˆ</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/richardgong1987-learn/docs/a-java/intro">Javaæ¶æ„å¸ˆå­¦ä¹ å†…å®¹ç›®å½•</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">javaå¹¶å‘ç¼–ç¨‹</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/richardgong1987-learn/docs/a-java/a-java-concurrent/intro">Javaå¹¶å‘ç¼–ç¨‹</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">concurent</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/richardgong1987-learn/docs/a-java/a-java-concurrent/nio">NIOã€ç½‘ç»œç¼–ç¨‹å’Œã€‘</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/richardgong1987-learn/docs/a-java/a-java-concurrent/threadlocal">ThreadLocalå…¨é¢è§£æ</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">threadpool</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">java-jvmæ€§èƒ½è°ƒä¼˜</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">javaæœåŠ¡æ¶æ„</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">kafka</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">rocketmq</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/richardgong1987-learn/docs/intro">å­¦ä¹ å¤§ä½¿</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">rustæ¶æ„å¸ˆ</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">è®¡ç®—æœºæœºç§‘å­¦</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>ThreadLocalå…¨é¢è§£æ</h1></header><ul><li><strong>äº†è§£ThreadLocalçš„ä»‹ç»</strong> </li><li><strong>æŒæ¡ThreadLocalçš„è¿ç”¨åœºæ™¯</strong></li><li><strong>äº†è§£ThreadLocalçš„å†…éƒ¨ç»“æ„</strong></li><li><strong>äº†è§£ThreadLocalçš„æ ¸å¿ƒæ–¹æ³•æºç </strong></li><li><strong>äº†è§£ThreadLocalMapçš„æºç </strong></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="1-threadlocalä»‹ç»"></a>1. ThreadLocalä»‹ç»<a class="hash-link" href="#1-threadlocalä»‹ç»" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="11-å®˜æ–¹ä»‹ç»"></a>1.1 å®˜æ–¹ä»‹ç»<a class="hash-link" href="#11-å®˜æ–¹ä»‹ç»" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * This class provides thread-local variables.  These variables differ from</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * their normal counterparts in that each thread that accesses one (via its</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@code get} or {@code set} method) has its own, independently initialized</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * copy of the variable.  {@code ThreadLocal} instances are typically private</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * static fields in classes that wish to associate state with a thread (e.g.,</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * a user ID or Transaction ID).</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;For example, the class below generates unique identifiers local to each</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * thread.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * A thread&#x27;s id is assigned the first time it invokes {@code ThreadId.get()}</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * and remains unchanged on subsequent calls.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;pre&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * import java.util.concurrent.atomic.AtomicInteger;</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * public class ThreadId {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     // Atomic integer containing the next thread ID to be assigned</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     private static final AtomicInteger nextId = new AtomicInteger(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     // Thread local variable containing each thread&#x27;s ID</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     private static final ThreadLocal&amp;lt;Integer&amp;gt; threadId =</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *         new ThreadLocal&amp;lt;Integer&amp;gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *             &amp;#64;Override protected Integer initialValue() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *                 return nextId.getAndIncrement();</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     };</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     // Returns the current thread&#x27;s unique ID, assigning it if necessary</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     public static int get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *         return threadId.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;/pre&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;Each thread holds an implicit reference to its copy of a thread-local</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * variable as long as the thread is alive and the {@code ThreadLocal}</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * instance is accessible; after a thread goes away, all of its copies of</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * thread-local instances are subject to garbage collection (unless other</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * references to these copies exist).</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author  Josh Bloch and Doug Lea</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @since   1.2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ThreadLocal&lt;T&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	ä»Javaå®˜æ–¹æ–‡æ¡£ä¸­çš„æè¿°ï¼šThreadLocalç±»ç”¨æ¥æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ã€‚è¿™ç§å˜é‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è®¿é—®ï¼ˆé€šè¿‡getå’Œsetæ–¹æ³•è®¿é—®ï¼‰æ—¶èƒ½ä¿è¯å„ä¸ªçº¿ç¨‹çš„å˜é‡ç›¸å¯¹ç‹¬ç«‹äºå…¶ä»–çº¿ç¨‹å†…çš„å˜é‡ã€‚ThreadLocalå®ä¾‹é€šå¸¸æ¥è¯´éƒ½æ˜¯private staticç±»å‹çš„ï¼Œç”¨äºå…³è”çº¿ç¨‹å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚</p><p>   	æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ ThreadLocal çš„ä½œç”¨æ˜¯ï¼šæä¾›çº¿ç¨‹å†…çš„å±€éƒ¨å˜é‡ï¼Œä¸åŒçš„çº¿ç¨‹ä¹‹é—´ä¸ä¼šç›¸äº’å¹²æ‰°ï¼Œè¿™ç§å˜é‡åœ¨çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå†…èµ·ä½œç”¨ï¼Œå‡å°‘åŒä¸€ä¸ªçº¿ç¨‹å†…å¤šä¸ªå‡½æ•°æˆ–ç»„ä»¶ä¹‹é—´ä¸€äº›å…¬å…±å˜é‡ä¼ é€’çš„å¤æ‚åº¦ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tex"><pre tabindex="0" class="prism-code language-tex codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">æ€»ç»“:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1. çº¿ç¨‹å¹¶å‘: åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„åœºæ™¯ä¸‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2. ä¼ é€’æ•°æ®: æˆ‘ä»¬å¯ä»¥é€šè¿‡ThreadLocalåœ¨åŒä¸€çº¿ç¨‹ï¼Œä¸åŒç»„ä»¶ä¸­ä¼ é€’å…¬å…±å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">3. çº¿ç¨‹éš”ç¦»: æ¯ä¸ªçº¿ç¨‹çš„å˜é‡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šäº’ç›¸å½±å“</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="12-åŸºæœ¬ä½¿ç”¨"></a>1.2 åŸºæœ¬ä½¿ç”¨<a class="hash-link" href="#12-åŸºæœ¬ä½¿ç”¨" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="121-å¸¸ç”¨æ–¹æ³•"></a>1.2.1 å¸¸ç”¨æ–¹æ³•<a class="hash-link" href="#121-å¸¸ç”¨æ–¹æ³•" title="Direct link to heading">#</a></h4><p>â€‹	åœ¨ä½¿ç”¨ä¹‹å‰,æˆ‘ä»¬å…ˆæ¥è®¤è¯†å‡ ä¸ªThreadLocalçš„å¸¸ç”¨æ–¹æ³•</p><table><thead><tr><th>æ–¹æ³•å£°æ˜</th><th>æè¿°</th></tr></thead><tbody><tr><td>ThreadLocal()</td><td>åˆ›å»ºThreadLocalå¯¹è±¡</td></tr><tr><td>public void set( T value)</td><td>è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public T get()</td><td>è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public void remove()</td><td>ç§»é™¤å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr></tbody></table><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="122-ä½¿ç”¨æ¡ˆä¾‹"></a>1.2.2 ä½¿ç”¨æ¡ˆä¾‹<a class="hash-link" href="#122-ä½¿ç”¨æ¡ˆä¾‹" title="Direct link to heading">#</a></h4><p> 	æˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªæ¡ˆä¾‹	, æ„Ÿå—ä¸€ä¸‹ThreadLocal çº¿ç¨‹éš”ç¦»çš„ç‰¹ç‚¹ï¼š </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyDemo {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String getContent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void setContent(String content) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.content = content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyDemo demo = new MyDemo();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 5; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread thread = new Thread(new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    demo.setContent(Thread.currentThread().getName() + &quot;çš„æ•°æ®&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(&quot;-----------------------&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + demo.getContent());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread.setName(&quot;çº¿ç¨‹&quot; + i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ‰“å°ç»“æœ:</p><p><img alt="1574149020726" src="data:image/png;base64,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"></p><p>â€‹	ä»ç»“æœå¯ä»¥çœ‹å‡ºå¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®åŒä¸€ä¸ªå˜é‡çš„æ—¶å€™å‡ºç°çš„å¼‚å¸¸ï¼Œçº¿ç¨‹é—´çš„æ•°æ®æ²¡æœ‰éš”ç¦»ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹é‡‡ç”¨ ThreadLocal çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¾‹å­ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyDemo {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static ThreadLocal&lt;String&gt; tl = new ThreadLocal&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String getContent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return tl.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void setContent(String content) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         tl.set(content);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyDemo demo = new MyDemo();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 5; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread thread = new Thread(new Runnable() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    demo.setContent(Thread.currentThread().getName() + &quot;çš„æ•°æ®&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(&quot;-----------------------&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + demo.getContent());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread.setName(&quot;çº¿ç¨‹&quot; + i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ‰“å°ç»“æœ: </p><p>â€‹			<img alt="1574149117289" src="data:image/png;base64,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"></p><p>ä»ç»“æœæ¥çœ‹ï¼Œè¿™æ ·å¾ˆå¥½çš„è§£å†³äº†å¤šçº¿ç¨‹ä¹‹é—´æ•°æ®éš”ç¦»çš„é—®é¢˜ï¼Œååˆ†æ–¹ä¾¿ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="13-threadlocalç±»ä¸synchronizedå…³é”®å­—"></a>1.3 ThreadLocalç±»ä¸synchronizedå…³é”®å­—<a class="hash-link" href="#13-threadlocalç±»ä¸synchronizedå…³é”®å­—" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="131-synchronizedåŒæ­¥æ–¹å¼"></a>1.3.1 synchronizedåŒæ­¥æ–¹å¼<a class="hash-link" href="#131-synchronizedåŒæ­¥æ–¹å¼" title="Direct link to heading">#</a></h4><p>â€‹	è¿™é‡Œå¯èƒ½æœ‰çš„æœ‹å‹ä¼šè§‰å¾—åœ¨ä¸Šè¿°ä¾‹å­ä¸­æˆ‘ä»¬å®Œå…¨å¯ä»¥é€šè¿‡åŠ é”æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ç”¨synchronizedä»£ç å—å®ç°çš„æ•ˆæœ:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class Demo02 {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getContent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setContent(String content) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.content = content;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Demo02 demo02 = new Demo02();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 5; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread t = new Thread(){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    synchronized (Demo02.class){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        demo02.setContent(Thread.currentThread().getName() + &quot;çš„æ•°æ®&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        System.out.println(&quot;-------------------------------------&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String content = demo02.getContent();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + content);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.setName(&quot;çº¿ç¨‹&quot; + i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            t.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>æ‰“å°ç»“æœ: </p><p>â€‹			<img alt="1578321788844" src="data:image/png;base64,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"></p><p>â€‹	ä»ç»“æœå¯ä»¥å‘ç°, åŠ é”ç¡®å®å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯åœ¨è¿™é‡Œæˆ‘ä»¬å¼ºè°ƒçš„æ˜¯çº¿ç¨‹æ•°æ®éš”ç¦»çš„é—®é¢˜ï¼Œå¹¶ä¸æ˜¯å¤šçº¿ç¨‹å…±äº«æ•°æ®çš„é—®é¢˜, åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ä½¿ç”¨synchronizedå…³é”®å­—æ˜¯ä¸åˆé€‚çš„ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="132-threadlocalä¸synchronizedçš„åŒºåˆ«"></a>1.3.2 ThreadLocalä¸synchronizedçš„åŒºåˆ«<a class="hash-link" href="#132-threadlocalä¸synchronizedçš„åŒºåˆ«" title="Direct link to heading">#</a></h4><p>â€‹	è™½ç„¶ThreadLocalæ¨¡å¼ä¸synchronizedå…³é”®å­—éƒ½ç”¨äºå¤„ç†å¤šçº¿ç¨‹å¹¶å‘è®¿é—®å˜é‡çš„é—®é¢˜, ä¸è¿‡ä¸¤è€…å¤„ç†é—®é¢˜çš„è§’åº¦å’Œæ€è·¯ä¸åŒã€‚</p><table><thead><tr><th></th><th>synchronized</th><th>ThreadLocal</th></tr></thead><tbody><tr><td>åŸç†</td><td>åŒæ­¥æœºåˆ¶é‡‡ç”¨&#x27;ä»¥æ—¶é—´æ¢ç©ºé—´&#x27;çš„æ–¹å¼, åªæä¾›äº†ä¸€ä»½å˜é‡,è®©ä¸åŒçš„çº¿ç¨‹æ’é˜Ÿè®¿é—®</td><td>ThreadLocalé‡‡ç”¨&#x27;ä»¥ç©ºé—´æ¢æ—¶é—´&#x27;çš„æ–¹å¼, ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æä¾›äº†ä¸€ä»½å˜é‡çš„å‰¯æœ¬,ä»è€Œå®ç°åŒæ—¶è®¿é—®è€Œç›¸ä¸å¹²æ‰°</td></tr><tr><td>ä¾§é‡ç‚¹</td><td>å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥</td><td>å¤šçº¿ç¨‹ä¸­è®©æ¯ä¸ªçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»</td></tr></tbody></table><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly tex"><pre tabindex="0" class="prism-code language-tex codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">æ€»ç»“ï¼š åœ¨åˆšåˆšçš„æ¡ˆä¾‹ä¸­ï¼Œè™½ç„¶ä½¿ç”¨ThreadLocalå’Œsynchronizedéƒ½èƒ½è§£å†³é—®é¢˜,ä½†æ˜¯ä½¿ç”¨ThreadLocalæ›´ä¸ºåˆé€‚,å› ä¸ºè¿™æ ·å¯ä»¥ä½¿ç¨‹åºæ‹¥æœ‰æ›´é«˜çš„å¹¶å‘æ€§ã€‚</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="2-è¿ç”¨åœºæ™¯_äº‹åŠ¡æ¡ˆä¾‹"></a>2. è¿ç”¨åœºæ™¯_äº‹åŠ¡æ¡ˆä¾‹<a class="hash-link" href="#2-è¿ç”¨åœºæ™¯_äº‹åŠ¡æ¡ˆä¾‹" title="Direct link to heading">#</a></h2><p>â€‹	é€šè¿‡ä»¥ä¸Šçš„ä»‹ç»ï¼Œæˆ‘ä»¬å·²ç»åŸºæœ¬äº†è§£ThreadLocalçš„ç‰¹ç‚¹ã€‚ä½†æ˜¯å®ƒå…·ä½“æ˜¯è¿ç”¨åœ¨ä»€ä¹ˆåœºæ™¯ä¸­å‘¢ï¼Ÿ æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªæ¡ˆä¾‹ï¼š äº‹åŠ¡æ“ä½œã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="21-è½¬è´¦æ¡ˆä¾‹"></a>2.1 è½¬è´¦æ¡ˆä¾‹<a class="hash-link" href="#21-è½¬è´¦æ¡ˆä¾‹" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="211-åœºæ™¯æ„å»º"></a>2.1.1 åœºæ™¯æ„å»º<a class="hash-link" href="#211-åœºæ™¯æ„å»º" title="Direct link to heading">#</a></h4><p>â€‹	è¿™é‡Œæˆ‘ä»¬å…ˆæ„å»ºä¸€ä¸ªç®€å•çš„è½¬è´¦åœºæ™¯ï¼š æœ‰ä¸€ä¸ªæ•°æ®è¡¨accountï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªç”¨æˆ·Jackå’ŒRoseï¼Œç”¨æˆ·Jack  ç»™ç”¨æˆ·Rose è½¬è´¦ã€‚ </p><p>â€‹	æ¡ˆä¾‹çš„å®ç°ä¸»è¦ç”¨mysqlæ•°æ®åº“ï¼ŒJDBC å’Œ C3P0 æ¡†æ¶ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†ä»£ç  ï¼š </p><p>â€‹	ï¼ˆ1ï¼‰ é¡¹ç›®ç»“æ„</p><p><img alt="1574045241145" src="/richardgong1987-learn/assets/images/001-e20d5ba40a5987df78480d223727b2b0.png"></p><p>â€‹	ï¼ˆ2ï¼‰ æ•°æ®å‡†å¤‡</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- ä½¿ç”¨æ•°æ®åº“</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> test</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- åˆ›å»ºä¸€å¼ è´¦æˆ·è¡¨</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    id </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">primary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">key</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">auto_increment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    money </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- åˆå§‹åŒ–æ•°æ®</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">insert</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> account </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Jack&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">insert</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> account </span><span class="token keyword" style="color:#00009f">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Rose&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	ï¼ˆ3ï¼‰ C3P0é…ç½®æ–‡ä»¶å’Œå·¥å…·ç±»</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">c3p0-config</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- ä½¿ç”¨é»˜è®¤çš„é…ç½®è¯»å–è¿æ¥æ± å¯¹è±¡ --&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">default-config</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!--  è¿æ¥å‚æ•° --&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">driverClass</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.mysql.jdbc.Driver</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">jdbcUrl</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">jdbc:mysql://localhost:3306/test</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">user</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">root</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">password</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1234</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- è¿æ¥æ± å‚æ•° --&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">initialPoolSize</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">5</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">maxPoolSize</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">10</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">checkoutTimeout</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">3000</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">default-config</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">c3p0-config</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹    	ï¼ˆ4ï¼‰ å·¥å…·ç±» ï¼š JdbcUtils</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.utils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mchange.v2.c3p0.ComboPooledDataSource;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JdbcUtils {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // c3p0 æ•°æ®åº“è¿æ¥æ± å¯¹è±¡å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ComboPooledDataSource ds = new ComboPooledDataSource();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è·å–è¿æ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Connection getConnection() throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ds.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //é‡Šæ”¾èµ„æº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void release(AutoCloseable... ios){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (AutoCloseable io : ios) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(io != null){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    io.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void commitAndClose(Connection conn) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(conn != null){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //æäº¤äº‹åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.commit();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //é‡Šæ”¾è¿æ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void rollbackAndClose(Connection conn) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(conn != null){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //å›æ»šäº‹åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.rollback();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //é‡Šæ”¾è¿æ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	ï¼ˆ5ï¼‰ daoå±‚ä»£ç  ï¼š AccountDao</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.dao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.utils.JdbcUtils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.PreparedStatement;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountDao {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void out(String outUser, int money) throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money - ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,outUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void in(String inUser, int money) throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money + ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,inUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	ï¼ˆ6ï¼‰ serviceå±‚ä»£ç  ï¼š AccountService</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.service;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.dao.AccountDao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean transfer(String outUser, String inUser, int money) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccountDao ad = new AccountDao();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è½¬å‡º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.out(outUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è½¬å…¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.in(inUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	ï¼ˆ7ï¼‰ webå±‚ä»£ç  ï¼š AccountWeb</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.web;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.service.AccountService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountWeb {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ¨¡æ‹Ÿæ•°æ® : Jack ç»™ Rose è½¬è´¦ 100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String outUser = &quot;Jack&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String inUser = &quot;Rose&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int money = 100;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccountService as = new AccountService();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean result = as.transfer(outUser, inUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (result == false) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;è½¬è´¦å¤±è´¥!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;è½¬è´¦æˆåŠŸ!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="212-å¼•å…¥äº‹åŠ¡"></a>2.1.2 å¼•å…¥äº‹åŠ¡<a class="hash-link" href="#212-å¼•å…¥äº‹åŠ¡" title="Direct link to heading">#</a></h4><p>â€‹	æ¡ˆä¾‹ä¸­çš„è½¬è´¦æ¶‰åŠä¸¤ä¸ªDMLæ“ä½œï¼š ä¸€ä¸ªè½¬å‡ºï¼Œä¸€ä¸ªè½¬å…¥ã€‚è¿™äº›æ“ä½œæ˜¯éœ€è¦å…·å¤‡åŸå­æ€§çš„ï¼Œä¸å¯åˆ†å‰²ã€‚ä¸ç„¶å°±æœ‰å¯èƒ½å‡ºç°æ•°æ®ä¿®æ”¹å¼‚å¸¸æƒ…å†µã€‚  </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean transfer(String outUser, String inUser, int money) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccountDao ad = new AccountDao();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è½¬å‡º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.out(outUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ¨¡æ‹Ÿè½¬è´¦è¿‡ç¨‹ä¸­çš„å¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int i = 1/0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è½¬å…¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.in(inUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	æ‰€ä»¥è¿™é‡Œå°±éœ€è¦æ“ä½œäº‹åŠ¡ï¼Œæ¥ä¿è¯è½¬å‡ºå’Œè½¬å…¥æ“ä½œå…·å¤‡åŸå­æ€§ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚</p><p> ï¼ˆ1ï¼‰ JDBCä¸­å…³äºäº‹åŠ¡çš„æ“ä½œçš„api</p><table><thead><tr><th>Connectionæ¥å£çš„æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>void  setAutoCommit(false)</td><td>ç¦ç”¨äº‹åŠ¡è‡ªåŠ¨æäº¤ï¼ˆæ”¹ä¸ºæ‰‹åŠ¨ï¼‰</td></tr><tr><td>void  commit();</td><td>æäº¤äº‹åŠ¡</td></tr><tr><td>void rollback();</td><td>å›æ»šäº‹åŠ¡</td></tr></tbody></table><p>  <strong>ï¼ˆ2ï¼‰ å¼€å¯äº‹åŠ¡çš„æ³¨æ„ç‚¹:</strong></p><ul><li><p>ä¸ºäº†ä¿è¯æ‰€æœ‰çš„æ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­,æ¡ˆä¾‹ä¸­ä½¿ç”¨çš„è¿æ¥å¿…é¡»æ˜¯åŒä¸€ä¸ª:  serviceå±‚å¼€å¯äº‹åŠ¡çš„connectionéœ€è¦è·Ÿdaoå±‚è®¿é—®æ•°æ®åº“çš„connectionä¿æŒä¸€è‡´</p></li><li><p>çº¿ç¨‹å¹¶å‘æƒ…å†µä¸‹, æ¯ä¸ªçº¿ç¨‹åªèƒ½æ“ä½œå„è‡ªçš„ connection</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="22--å¸¸è§„è§£å†³æ–¹æ¡ˆ"></a>2.2  å¸¸è§„è§£å†³æ–¹æ¡ˆ<a class="hash-link" href="#22--å¸¸è§„è§£å†³æ–¹æ¡ˆ" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="221-å¸¸è§„æ–¹æ¡ˆçš„å®ç°"></a>2.2.1 å¸¸è§„æ–¹æ¡ˆçš„å®ç°<a class="hash-link" href="#221-å¸¸è§„æ–¹æ¡ˆçš„å®ç°" title="Direct link to heading">#</a></h4><p>åŸºäºä¸Šé¢ç»™å‡ºçš„å‰æï¼Œ å¤§å®¶é€šå¸¸æƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆæ˜¯ ï¼š </p><ul><li>ä¼ å‚: ä»serviceå±‚å°†connectionå¯¹è±¡å‘daoå±‚ä¼ é€’ </li><li>åŠ é”</li></ul><p>ä»¥ä¸‹æ˜¯ä»£ç å®ç°ä¿®æ”¹çš„éƒ¨åˆ†ï¼š </p><p>â€‹	ï¼ˆ1 ) AccountService ç±» </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.service;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.dao.AccountDao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.utils.JdbcUtils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean transfer(String outUser, String inUser, int money) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccountDao ad = new AccountDao();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //çº¿ç¨‹å¹¶å‘æƒ…å†µä¸‹,ä¸ºäº†ä¿è¯æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å„è‡ªçš„connection,æ•…åŠ é”</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (AccountService.class) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //å¼€å¯äº‹åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn.setAutoCommit(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è½¬å‡º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ad.out(conn, outUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æ¨¡æ‹Ÿè½¬è´¦è¿‡ç¨‹ä¸­çš„å¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//            int i = 1/0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è½¬å…¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ad.in(conn, inUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //äº‹åŠ¡æäº¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                JdbcUtils.commitAndClose(conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //äº‹åŠ¡å›æ»š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                JdbcUtils.rollbackAndClose(conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	ï¼ˆ2) AccountDao ç±» ï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š connectionä¸èƒ½åœ¨daoå±‚é‡Šæ”¾ï¼Œè¦åœ¨serviceå±‚ï¼Œä¸ç„¶åœ¨daoå±‚é‡Šæ”¾ï¼Œserviceå±‚å°±æ— æ³•ä½¿ç”¨äº†ï¼‰</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.dao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.utils.JdbcUtils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.PreparedStatement;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountDao {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void out(Connection conn, String outUser, int money) throws SQLException{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money - ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ³¨é‡Šä»è¿æ¥æ± è·å–è¿æ¥çš„ä»£ç ,ä½¿ç”¨ä»serviceä¸­ä¼ é€’è¿‡æ¥çš„connection</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,outUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è¿æ¥ä¸èƒ½åœ¨è¿™é‡Œé‡Šæ”¾,serviceå±‚ä¸­è¿˜éœ€è¦ä½¿ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void in(Connection conn, String inUser, int money) throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money + ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,inUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="222-å¸¸è§„æ–¹æ¡ˆçš„å¼Šç«¯"></a>2.2.2 å¸¸è§„æ–¹æ¡ˆçš„å¼Šç«¯<a class="hash-link" href="#222-å¸¸è§„æ–¹æ¡ˆçš„å¼Šç«¯" title="Direct link to heading">#</a></h4><p>ä¸Šè¿°æ–¹å¼æˆ‘ä»¬çœ‹åˆ°çš„ç¡®æŒ‰è¦æ±‚è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯ä»”ç»†è§‚å¯Ÿï¼Œä¼šå‘ç°è¿™æ ·å®ç°çš„å¼Šç«¯ï¼š </p><ol><li><p>ç›´æ¥ä»serviceå±‚ä¼ é€’connectionåˆ°daoå±‚, é€ æˆä»£ç è€¦åˆåº¦æé«˜</p></li><li><p>åŠ é”ä¼šé€ æˆçº¿ç¨‹å¤±å»å¹¶å‘æ€§ï¼Œç¨‹åºæ€§èƒ½é™ä½</p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="23-threadlocalè§£å†³æ–¹æ¡ˆ"></a>2.3 ThreadLocalè§£å†³æ–¹æ¡ˆ<a class="hash-link" href="#23-threadlocalè§£å†³æ–¹æ¡ˆ" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="231-threadlocalæ–¹æ¡ˆçš„å®ç°"></a>2.3.1 ThreadLocalæ–¹æ¡ˆçš„å®ç°<a class="hash-link" href="#231-threadlocalæ–¹æ¡ˆçš„å®ç°" title="Direct link to heading">#</a></h4><p>åƒè¿™ç§éœ€è¦åœ¨é¡¹ç›®ä¸­è¿›è¡Œ<strong>æ•°æ®ä¼ é€’</strong>å’Œ<strong>çº¿ç¨‹éš”ç¦»</strong>çš„åœºæ™¯ï¼Œæˆ‘ä»¬ä¸å¦¨ç”¨ThreadLocalæ¥è§£å†³ï¼š </p><p>â€‹	ï¼ˆ1ï¼‰ å·¥å…·ç±»çš„ä¿®æ”¹ï¼š åŠ å…¥ThreadLocal</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.utils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.mchange.v2.c3p0.ComboPooledDataSource;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JdbcUtils {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ThreadLocalå¯¹è±¡ : å°†connectionç»‘å®šåœ¨å½“å‰çº¿ç¨‹ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ThreadLocal&lt;Connection&gt; tl = new ThreadLocal();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // c3p0 æ•°æ®åº“è¿æ¥æ± å¯¹è±¡å±æ€§</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ComboPooledDataSource ds = new ComboPooledDataSource();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è·å–è¿æ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Connection getConnection() throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å–å‡ºå½“å‰çº¿ç¨‹ç»‘å®šçš„connectionå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = tl.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (conn == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä»è¿æ¥æ± ä¸­å–å‡º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn = ds.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å†å°†connectionå¯¹è±¡ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            tl.set(conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return conn;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //é‡Šæ”¾èµ„æº</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void release(AutoCloseable... ios) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (AutoCloseable io : ios) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (io != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    io.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void commitAndClose() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æäº¤äº‹åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.commit();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //è§£é™¤ç»‘å®š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            tl.remove();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //é‡Šæ”¾è¿æ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void rollbackAndClose() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å›æ»šäº‹åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.rollback();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //è§£é™¤ç»‘å®š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            tl.remove();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //é‡Šæ”¾è¿æ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.close();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (SQLException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	ï¼ˆ2ï¼‰ AccountServiceç±»çš„ä¿®æ”¹ï¼šä¸éœ€è¦ä¼ é€’connectionå¯¹è±¡</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.service;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.dao.AccountDao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.utils.JdbcUtils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean transfer(String outUser, String inUser, int money) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AccountDao ad = new AccountDao();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //å¼€å¯äº‹åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn.setAutoCommit(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è½¬å‡º ï¼š è¿™é‡Œä¸éœ€è¦ä¼ å‚äº† ï¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.out(outUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ¨¡æ‹Ÿè½¬è´¦è¿‡ç¨‹ä¸­çš„å¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//            int i = 1 / 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è½¬å…¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ad.in(inUser, money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //äº‹åŠ¡æäº¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            JdbcUtils.commitAndClose();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //äº‹åŠ¡å›æ»š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           JdbcUtils.rollbackAndClose();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	ï¼ˆ3ï¼‰ AccountDaoç±»çš„ä¿®æ”¹ï¼šç…§å¸¸ä½¿ç”¨</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.itheima.transfer.dao;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.itheima.transfer.utils.JdbcUtils;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.Connection;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.PreparedStatement;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.sql.SQLException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AccountDao {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void out(String outUser, int money) throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money - ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,outUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ç…§å¸¸ä½¿ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void in(String inUser, int money) throws SQLException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;update account set money = money + ? where name = ?&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Connection conn = JdbcUtils.getConnection();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PreparedStatement pstm = conn.prepareStatement(sql);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setInt(1,money);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.setString(2,inUser);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pstm.executeUpdate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//        JdbcUtils.release(pstm,conn);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JdbcUtils.release(pstm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="232-threadlocalæ–¹æ¡ˆçš„å¥½å¤„"></a>2.3.2 ThreadLocalæ–¹æ¡ˆçš„å¥½å¤„<a class="hash-link" href="#232-threadlocalæ–¹æ¡ˆçš„å¥½å¤„" title="Direct link to heading">#</a></h4><p>ä»ä¸Šè¿°çš„æ¡ˆä¾‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ åœ¨ä¸€äº›ç‰¹å®šåœºæ™¯ä¸‹ï¼ŒThreadLocalæ–¹æ¡ˆæœ‰ä¸¤ä¸ªçªå‡ºçš„ä¼˜åŠ¿ï¼š </p><ol><li><p>ä¼ é€’æ•°æ® ï¼š ä¿å­˜æ¯ä¸ªçº¿ç¨‹ç»‘å®šçš„æ•°æ®ï¼Œåœ¨éœ€è¦çš„åœ°æ–¹å¯ä»¥ç›´æ¥è·å–, é¿å…å‚æ•°ç›´æ¥ä¼ é€’å¸¦æ¥çš„ä»£ç è€¦åˆé—®é¢˜</p></li><li><p>çº¿ç¨‹éš”ç¦» ï¼š å„çº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»å´åˆå…·å¤‡å¹¶å‘æ€§ï¼Œé¿å…åŒæ­¥æ–¹å¼å¸¦æ¥çš„æ€§èƒ½æŸå¤±</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="3-threadlocalçš„å†…éƒ¨ç»“æ„"></a>3. ThreadLocalçš„å†…éƒ¨ç»“æ„<a class="hash-link" href="#3-threadlocalçš„å†…éƒ¨ç»“æ„" title="Direct link to heading">#</a></h2><p>â€‹	é€šè¿‡ä»¥ä¸Šçš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯¹ThreadLocalçš„ä½œç”¨æœ‰äº†ä¸€å®šçš„è®¤è¯†ã€‚ç°åœ¨æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ThreadLocalçš„å†…éƒ¨ç»“æ„ï¼Œæ¢ç©¶å®ƒèƒ½å¤Ÿå®ç°çº¿ç¨‹æ•°æ®éš”ç¦»çš„åŸç†ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="31--å¸¸è§çš„è¯¯è§£"></a>3.1  å¸¸è§çš„è¯¯è§£<a class="hash-link" href="#31--å¸¸è§çš„è¯¯è§£" title="Direct link to heading">#</a></h3><p>â€‹	å¦‚æœæˆ‘ä»¬ä¸å»çœ‹æºä»£ç çš„è¯ï¼Œå¯èƒ½ä¼šçŒœæµ‹<code>ThreadLocal</code>æ˜¯è¿™æ ·å­è®¾è®¡çš„ï¼šæ¯ä¸ª<code>ThreadLocal</code>éƒ½åˆ›å»ºä¸€ä¸ª<code>Map</code>ï¼Œç„¶åç”¨çº¿ç¨‹ä½œä¸º<code>Map</code>çš„<code>key</code>ï¼Œè¦å­˜å‚¨çš„å±€éƒ¨å˜é‡ä½œä¸º<code>Map</code>çš„<code>value</code>ï¼Œè¿™æ ·å°±èƒ½è¾¾åˆ°å„ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡éš”ç¦»çš„æ•ˆæœã€‚è¿™æ˜¯æœ€ç®€å•çš„è®¾è®¡æ–¹æ³•ï¼ŒJDKæœ€æ—©æœŸçš„<code>ThreadLocal</code> ç¡®å®æ˜¯è¿™æ ·è®¾è®¡çš„ï¼Œä½†ç°åœ¨æ—©å·²ä¸æ˜¯äº†ã€‚</p><p><img alt="1582788729557" src="/richardgong1987-learn/assets/images/008-54cdede3f8dbbbc835d89c6111d34b07.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="32--ç°åœ¨çš„è®¾è®¡"></a>3.2  ç°åœ¨çš„è®¾è®¡<a class="hash-link" href="#32--ç°åœ¨çš„è®¾è®¡" title="Direct link to heading">#</a></h3><p>â€‹	ä½†æ˜¯ï¼ŒJDKåé¢ä¼˜åŒ–äº†è®¾è®¡æ–¹æ¡ˆï¼Œåœ¨JDK8ä¸­ <code>ThreadLocal</code>çš„è®¾è®¡æ˜¯ï¼šæ¯ä¸ª<code>Thread</code>ç»´æŠ¤ä¸€ä¸ª<code>ThreadLocalMap</code>ï¼Œè¿™ä¸ªMapçš„<code>key</code>æ˜¯<code>ThreadLocal</code>å®ä¾‹æœ¬èº«ï¼Œ<code>value</code>æ‰æ˜¯çœŸæ­£è¦å­˜å‚¨çš„å€¼<code>Object</code>ã€‚</p><p>å…·ä½“çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p>â€‹	ï¼ˆ1ï¼‰ æ¯ä¸ªThreadçº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªMap (ThreadLocalMap)
â€‹	ï¼ˆ2ï¼‰ Mapé‡Œé¢å­˜å‚¨ThreadLocalå¯¹è±¡ï¼ˆkeyï¼‰å’Œçº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼ˆvalueï¼‰
â€‹	ï¼ˆ3ï¼‰Threadå†…éƒ¨çš„Mapæ˜¯ç”±ThreadLocalç»´æŠ¤çš„ï¼Œç”±ThreadLocalè´Ÿè´£å‘mapè·å–å’Œè®¾ç½®çº¿ç¨‹çš„å˜é‡å€¼ã€‚
â€‹	ï¼ˆ4ï¼‰å¯¹äºä¸åŒçš„çº¿ç¨‹ï¼Œæ¯æ¬¡è·å–å‰¯æœ¬å€¼æ—¶ï¼Œåˆ«çš„çº¿ç¨‹å¹¶ä¸èƒ½è·å–åˆ°å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å€¼ï¼Œå½¢æˆäº†å‰¯æœ¬çš„éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°ã€‚	</p><p><img alt="1574155226793" src="/richardgong1987-learn/assets/images/004-2a884ca053576188ab7732799ad25317.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="33-è¿™æ ·è®¾è®¡çš„å¥½å¤„"></a>3.3 è¿™æ ·è®¾è®¡çš„å¥½å¤„<a class="hash-link" href="#33-è¿™æ ·è®¾è®¡çš„å¥½å¤„" title="Direct link to heading">#</a></h3><p>â€‹	è¿™ä¸ªè®¾è®¡ä¸æˆ‘ä»¬ä¸€å¼€å§‹è¯´çš„è®¾è®¡åˆšå¥½ç›¸åï¼Œè¿™æ ·è®¾è®¡æœ‰å¦‚ä¸‹ä¸¤ä¸ªä¼˜åŠ¿ï¼š</p><p>ï¼ˆ1ï¼‰ è¿™æ ·è®¾è®¡ä¹‹åæ¯ä¸ª<code>Map</code>å­˜å‚¨çš„<code>Entry</code>æ•°é‡å°±ä¼šå˜å°‘ã€‚å› ä¸ºä¹‹å‰çš„å­˜å‚¨æ•°é‡ç”±<code>Thread</code>çš„æ•°é‡å†³å®šï¼Œç°åœ¨æ˜¯ç”±<code>ThreadLocal</code>çš„æ•°é‡å†³å®šã€‚åœ¨å®é™…è¿ç”¨å½“ä¸­ï¼Œå¾€å¾€ThreadLocalçš„æ•°é‡è¦å°‘äºThreadçš„æ•°é‡ã€‚</p><p>ï¼ˆ2ï¼‰ å½“<code>Thread</code>é”€æ¯ä¹‹åï¼Œå¯¹åº”çš„<code>ThreadLocalMap</code>ä¹Ÿä¼šéšä¹‹é”€æ¯ï¼Œèƒ½å‡å°‘å†…å­˜çš„ä½¿ç”¨ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="4-threadlocalçš„æ ¸å¿ƒæ–¹æ³•æºç "></a>4. ThreadLocalçš„æ ¸å¿ƒæ–¹æ³•æºç <a class="hash-link" href="#4-threadlocalçš„æ ¸å¿ƒæ–¹æ³•æºç " title="Direct link to heading">#</a></h2><p>â€‹	åŸºäºThreadLocalçš„å†…éƒ¨ç»“æ„ï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æå®ƒçš„æ ¸å¿ƒæ–¹æ³•æºç ï¼Œæ›´æ·±å…¥çš„äº†è§£å…¶æ“ä½œåŸç†ã€‚</p><p>é™¤äº†æ„é€ æ–¹æ³•ä¹‹å¤–ï¼Œ ThreadLocalå¯¹å¤–æš´éœ²çš„æ–¹æ³•æœ‰ä»¥ä¸‹4ä¸ªï¼š</p><table><thead><tr><th>æ–¹æ³•å£°æ˜</th><th>æè¿°</th></tr></thead><tbody><tr><td>protected T initialValue()</td><td>è¿”å›å½“å‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼</td></tr><tr><td>public void set( T value)</td><td>è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public T get()</td><td>è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public void remove()</td><td>ç§»é™¤å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr></tbody></table><p>â€‹	ä»¥ä¸‹æ˜¯è¿™4ä¸ªæ–¹æ³•çš„è¯¦ç»†æºç åˆ†æ(ä¸ºäº†ä¿è¯æ€è·¯æ¸…æ™°, ThreadLocalMapéƒ¨åˆ†æš‚æ—¶ä¸å±•å¼€,ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹è¯¦è§£)</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="41-setæ–¹æ³•"></a>4.1 setæ–¹æ³•<a class="hash-link" href="#41-setæ–¹æ³•" title="Direct link to heading">#</a></h3><p><strong>ï¼ˆ1 ) æºç å’Œå¯¹åº”çš„ä¸­æ–‡æ³¨é‡Š</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è®¾ç½®å½“å‰çº¿ç¨‹å¯¹åº”çš„ThreadLocalçš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param value å°†è¦ä¿å­˜åœ¨å½“å‰çº¿ç¨‹å¯¹åº”çš„ThreadLocalçš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void set(T value) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread t = Thread.currentThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadLocalMap map = getMap(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ¤æ–­mapæ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (map != null)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å­˜åœ¨åˆ™è°ƒç”¨map.setè®¾ç½®æ­¤å®ä½“entry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.set(this, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1ï¼‰å½“å‰çº¿ç¨‹Thread ä¸å­˜åœ¨ThreadLocalMapå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2ï¼‰åˆ™è°ƒç”¨createMapè¿›è¡ŒThreadLocalMapå¯¹è±¡çš„åˆå§‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3ï¼‰å¹¶å°† t(å½“å‰çº¿ç¨‹)å’Œvalue(tå¯¹åº”çš„å€¼)ä½œä¸ºç¬¬ä¸€ä¸ªentryå­˜æ”¾è‡³ThreadLocalMapä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            createMap(t, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è·å–å½“å‰çº¿ç¨‹Threadå¯¹åº”ç»´æŠ¤çš„ThreadLocalMap </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param  t the current thread å½“å‰çº¿ç¨‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the map å¯¹åº”ç»´æŠ¤çš„ThreadLocalMap </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ThreadLocalMap getMap(Thread t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return t.threadLocals;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *åˆ›å»ºå½“å‰çº¿ç¨‹Threadå¯¹åº”ç»´æŠ¤çš„ThreadLocalMap </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param t å½“å‰çº¿ç¨‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param firstValue å­˜æ”¾åˆ°mapä¸­ç¬¬ä¸€ä¸ªentryçš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void createMap(Thread t, T firstValue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è¿™é‡Œçš„thisæ˜¯è°ƒç”¨æ­¤æ–¹æ³•çš„threadLocal</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.threadLocals = new ThreadLocalMap(this, firstValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>ï¼ˆ2 )  ä»£ç æ‰§è¡Œæµç¨‹</strong></p><p>â€‹	A. é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ªMap</p><p>â€‹	B. å¦‚æœè·å–çš„Mapä¸ä¸ºç©ºï¼Œåˆ™å°†å‚æ•°è®¾ç½®åˆ°Mapä¸­ï¼ˆå½“å‰ThreadLocalçš„å¼•ç”¨ä½œä¸ºkeyï¼‰</p><p>â€‹	C. å¦‚æœMapä¸ºç©ºï¼Œåˆ™ç»™è¯¥çº¿ç¨‹åˆ›å»º Mapï¼Œå¹¶è®¾ç½®åˆå§‹å€¼</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="42-getæ–¹æ³•"></a>4.2 getæ–¹æ³•<a class="hash-link" href="#42-getæ–¹æ³•" title="Direct link to heading">#</a></h3><p><strong>ï¼ˆ1 ) æºç å’Œå¯¹åº”çš„ä¸­æ–‡æ³¨é‡Š</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è¿”å›å½“å‰çº¿ç¨‹ä¸­ä¿å­˜ThreadLocalçš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰æ­¤ThreadLocalå˜é‡ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ™å®ƒä¼šé€šè¿‡è°ƒç”¨{@link #initialValue} æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return è¿”å›å½“å‰çº¿ç¨‹å¯¹åº”æ­¤ThreadLocalçš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public T get() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread t = Thread.currentThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadLocalMap map = getMap(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæ­¤mapå­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (map != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä»¥å½“å‰çš„ThreadLocal ä¸º keyï¼Œè°ƒç”¨getEntryè·å–å¯¹åº”çš„å­˜å‚¨å®ä½“e</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadLocalMap.Entry e = map.getEntry(this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¯¹eè¿›è¡Œåˆ¤ç©º </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (e != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è·å–å­˜å‚¨å®ä½“ e å¯¹åº”çš„ valueå€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å³ä¸ºæˆ‘ä»¬æƒ³è¦çš„å½“å‰çº¿ç¨‹å¯¹åº”æ­¤ThreadLocalçš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                T result = (T)e.value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /*</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            åˆå§‹åŒ– : æœ‰ä¸¤ç§æƒ…å†µæœ‰æ‰§è¡Œå½“å‰ä»£ç </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ç¬¬ä¸€ç§æƒ…å†µ: mapä¸å­˜åœ¨ï¼Œè¡¨ç¤ºæ­¤çº¿ç¨‹æ²¡æœ‰ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ç¬¬äºŒç§æƒ…å†µ: mapå­˜åœ¨, ä½†æ˜¯æ²¡æœ‰ä¸å½“å‰ThreadLocalå…³è”çš„entry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return setInitialValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆå§‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the initial value åˆå§‹åŒ–åçš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private T setInitialValue() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è°ƒç”¨initialValueè·å–åˆå§‹åŒ–çš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ­¤æ–¹æ³•å¯ä»¥è¢«å­ç±»é‡å†™, å¦‚æœä¸é‡å†™é»˜è®¤è¿”å›null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        T value = initialValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread t = Thread.currentThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadLocalMap map = getMap(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ¤æ–­mapæ˜¯å¦å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (map != null)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å­˜åœ¨åˆ™è°ƒç”¨map.setè®¾ç½®æ­¤å®ä½“entry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.set(this, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1ï¼‰å½“å‰çº¿ç¨‹Thread ä¸å­˜åœ¨ThreadLocalMapå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2ï¼‰åˆ™è°ƒç”¨createMapè¿›è¡ŒThreadLocalMapå¯¹è±¡çš„åˆå§‹åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3ï¼‰å¹¶å°† t(å½“å‰çº¿ç¨‹)å’Œvalue(tå¯¹åº”çš„å€¼)ä½œä¸ºç¬¬ä¸€ä¸ªentryå­˜æ”¾è‡³ThreadLocalMapä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            createMap(t, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿”å›è®¾ç½®çš„å€¼value</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>ï¼ˆ2 )  ä»£ç æ‰§è¡Œæµç¨‹</strong> </p><p>â€‹	A. é¦–å…ˆè·å–å½“å‰çº¿ç¨‹, æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ªMap</p><p>â€‹	B. å¦‚æœè·å–çš„Mapä¸ä¸ºç©ºï¼Œåˆ™åœ¨Mapä¸­ä»¥ThreadLocalçš„å¼•ç”¨ä½œä¸ºkeyæ¥åœ¨Mapä¸­è·å–å¯¹åº”çš„Entry eï¼Œå¦åˆ™è½¬åˆ°D</p><p>â€‹	C. å¦‚æœeä¸ä¸ºnullï¼Œåˆ™è¿”å›e.valueï¼Œå¦åˆ™è½¬åˆ°D</p><p>â€‹	D. Mapä¸ºç©ºæˆ–è€…eä¸ºç©ºï¼Œåˆ™é€šè¿‡initialValueå‡½æ•°è·å–åˆå§‹å€¼valueï¼Œç„¶åç”¨ThreadLocalçš„å¼•ç”¨å’Œvalueä½œä¸ºfirstKeyå’ŒfirstValueåˆ›å»ºä¸€ä¸ªæ–°çš„Map</p><p>æ€»ç»“:  <strong>å…ˆè·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å˜é‡ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›å€¼ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºå¹¶è¿”å›åˆå§‹å€¼ã€‚</strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="43-removeæ–¹æ³•"></a>4.3 removeæ–¹æ³•<a class="hash-link" href="#43-removeæ–¹æ³•" title="Direct link to heading">#</a></h3><p><strong>ï¼ˆ1 ) æºç å’Œå¯¹åº”çš„ä¸­æ–‡æ³¨é‡Š</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ é™¤å½“å‰çº¿ç¨‹ä¸­ä¿å­˜çš„ThreadLocalå¯¹åº”çš„å®ä½“entry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     public void remove() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         ThreadLocalMap m = getMap(Thread.currentThread());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæ­¤mapå­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         if (m != null)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å­˜åœ¨åˆ™è°ƒç”¨map.remove</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä»¥å½“å‰ThreadLocalä¸ºkeyåˆ é™¤å¯¹åº”çš„å®ä½“entry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             m.remove(this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>ï¼ˆ2 )  ä»£ç æ‰§è¡Œæµç¨‹</strong></p><p>â€‹	A. é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ªMap</p><p>â€‹	B. å¦‚æœè·å–çš„Mapä¸ä¸ºç©ºï¼Œåˆ™ç§»é™¤å½“å‰ThreadLocalå¯¹è±¡å¯¹åº”çš„entry</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="44-initialvalueæ–¹æ³•"></a><strong>4.4 initialValueæ–¹æ³•</strong><a class="hash-link" href="#44-initialvalueæ–¹æ³•" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * è¿”å›å½“å‰çº¿ç¨‹å¯¹åº”çš„ThreadLocalçš„åˆå§‹å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * æ­¤æ–¹æ³•çš„ç¬¬ä¸€æ¬¡è°ƒç”¨å‘ç”Ÿåœ¨ï¼Œå½“çº¿ç¨‹é€šè¿‡getæ–¹æ³•è®¿é—®æ­¤çº¿ç¨‹çš„ThreadLocalå€¼æ—¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * é™¤éçº¿ç¨‹å…ˆè°ƒç”¨äº†setæ–¹æ³•ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒinitialValue æ‰ä¸ä¼šè¢«è¿™ä¸ªçº¿ç¨‹è°ƒç”¨ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * é€šå¸¸æƒ…å†µä¸‹ï¼Œæ¯ä¸ªçº¿ç¨‹æœ€å¤šè°ƒç”¨ä¸€æ¬¡è¿™ä¸ªæ–¹æ³•ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * &lt;p&gt;è¿™ä¸ªæ–¹æ³•ä»…ä»…ç®€å•çš„è¿”å›null {@code null};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * å¦‚æœç¨‹åºå‘˜æƒ³ThreadLocalçº¿ç¨‹å±€éƒ¨å˜é‡æœ‰ä¸€ä¸ªé™¤nullä»¥å¤–çš„åˆå§‹å€¼ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * å¿…é¡»é€šè¿‡å­ç±»ç»§æ‰¿{@code ThreadLocal} çš„æ–¹å¼å»é‡å†™æ­¤æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * é€šå¸¸, å¯ä»¥é€šè¿‡åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * @return å½“å‰ThreadLocalçš„åˆå§‹å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected T initialValue() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	æ­¤æ–¹æ³•çš„ä½œç”¨æ˜¯ è¿”å›è¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼ã€‚</p><p>ï¼ˆ1ï¼‰ è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå»¶è¿Ÿè°ƒç”¨æ–¹æ³•ï¼Œä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¾—çŸ¥ï¼Œåœ¨setæ–¹æ³•è¿˜æœªè°ƒç”¨è€Œå…ˆè°ƒç”¨äº†getæ–¹æ³•æ—¶æ‰æ‰§è¡Œï¼Œå¹¶ä¸”ä»…æ‰§è¡Œ1æ¬¡ã€‚</p><p>ï¼ˆ2ï¼‰è¿™ä¸ªæ–¹æ³•ç¼ºçœå®ç°ç›´æ¥è¿”å›ä¸€ä¸ª<code>null</code>ã€‚</p><p>ï¼ˆ3ï¼‰å¦‚æœæƒ³è¦ä¸€ä¸ªé™¤nullä¹‹å¤–çš„åˆå§‹å€¼ï¼Œå¯ä»¥é‡å†™æ­¤æ–¹æ³•ã€‚ï¼ˆå¤‡æ³¨ï¼š è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ª<code>protected</code>çš„æ–¹æ³•ï¼Œæ˜¾ç„¶æ˜¯ä¸ºäº†è®©å­ç±»è¦†ç›–è€Œè®¾è®¡çš„ï¼‰</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="5-threadlocalmapæºç åˆ†æ"></a>5. ThreadLocalMapæºç åˆ†æ<a class="hash-link" href="#5-threadlocalmapæºç åˆ†æ" title="Direct link to heading">#</a></h2><p>â€‹	åœ¨åˆ†æThreadLocalæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬äº†è§£åˆ°ThreadLocalçš„æ“ä½œå®é™…ä¸Šæ˜¯å›´ç»•ThreadLocalMapå±•å¼€çš„ã€‚ThreadLocalMapçš„æºç ç›¸å¯¹æ¯”è¾ƒå¤æ‚, æˆ‘ä»¬ä»ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢è¿›è¡Œè®¨è®ºã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="51-åŸºæœ¬ç»“æ„"></a>5.1 åŸºæœ¬ç»“æ„<a class="hash-link" href="#51-åŸºæœ¬ç»“æ„" title="Direct link to heading">#</a></h3><p>â€‹	ThreadLocalMapæ˜¯ThreadLocalçš„å†…éƒ¨ç±»ï¼Œæ²¡æœ‰å®ç°Mapæ¥å£ï¼Œç”¨ç‹¬ç«‹çš„æ–¹å¼å®ç°äº†Mapçš„åŠŸèƒ½ï¼Œå…¶å†…éƒ¨çš„Entryä¹Ÿæ˜¯ç‹¬ç«‹å®ç°ã€‚</p><p>   <img alt="1574266262577" src="/richardgong1987-learn/assets/images/005-bd5310f31ddcbbcab43b2327a98d1bd1.png"></p><p><strong>ï¼ˆ1ï¼‰ æˆå‘˜å˜é‡</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆå§‹å®¹é‡ â€”â€” å¿…é¡»æ˜¯2çš„æ•´æ¬¡å¹‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int INITIAL_CAPACITY = 16;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å­˜æ”¾æ•°æ®çš„tableï¼ŒEntryç±»çš„å®šä¹‰åœ¨ä¸‹é¢åˆ†æ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åŒæ ·ï¼Œæ•°ç»„é•¿åº¦å¿…é¡»æ˜¯2çš„æ•´æ¬¡å¹‚ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Entry[] table;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ•°ç»„é‡Œé¢entrysçš„ä¸ªæ•°ï¼Œå¯ä»¥ç”¨äºåˆ¤æ–­tableå½“å‰ä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int size = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼ï¼Œè¡¨ä½¿ç”¨é‡å¤§äºå®ƒçš„æ—¶å€™è¿›è¡Œæ‰©å®¹ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int threshold; // Default to 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	è·ŸHashMapç±»ä¼¼ï¼ŒINITIAL_CAPACITYä»£è¡¨è¿™ä¸ªMapçš„åˆå§‹å®¹é‡ï¼›table æ˜¯ä¸€ä¸ªEntry ç±»å‹çš„æ•°ç»„ï¼Œç”¨äºå­˜å‚¨æ•°æ®ï¼›size ä»£è¡¨è¡¨ä¸­çš„å­˜å‚¨æ•°ç›®ï¼› threshold ä»£è¡¨éœ€è¦æ‰©å®¹æ—¶å¯¹åº” size çš„é˜ˆå€¼ã€‚</p><p>é“¾æ¥ï¼š<a href="https://www.jianshu.com/p/acfd2239c9f4" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/acfd2239c9f4</a></p><p>æ¥æºï¼šç®€ä¹¦</p><p>è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><p><strong>ï¼ˆ2ï¼‰ å­˜å‚¨ç»“æ„ - Entry</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Entryç»§æ‰¿WeakReferenceï¼Œå¹¶ä¸”ç”¨ThreadLocalä½œä¸ºkey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * å¦‚æœkeyä¸ºnull(entry.get() == null)ï¼Œæ„å‘³ç€keyä¸å†è¢«å¼•ç”¨ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * å› æ­¤è¿™æ—¶å€™entryä¹Ÿå¯ä»¥ä»tableä¸­æ¸…é™¤ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /** The value associated with this ThreadLocal. */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Entry(ThreadLocal&lt;?&gt; k, Object v) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(k);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        value = v;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	 åœ¨ThreadLocalMapä¸­ï¼Œä¹Ÿæ˜¯ç”¨Entryæ¥ä¿å­˜K-Vç»“æ„æ•°æ®çš„ã€‚ä¸è¿‡Entryä¸­çš„keyåªèƒ½æ˜¯ThreadLocalå¯¹è±¡ï¼Œè¿™ç‚¹åœ¨æ„é€ æ–¹æ³•ä¸­å·²ç»é™å®šæ­»äº†ã€‚</p><p>â€‹	å¦å¤–ï¼ŒEntryç»§æ‰¿WeakReferenceï¼Œä¹Ÿå°±æ˜¯keyï¼ˆThreadLocalï¼‰æ˜¯å¼±å¼•ç”¨ï¼Œå…¶ç›®çš„æ˜¯å°†ThreadLocalå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè§£ç»‘ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="52-å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼"></a>5.2 å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼<a class="hash-link" href="#52-å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼" title="Direct link to heading">#</a></h3><p>â€‹	æœ‰äº›ç¨‹åºå‘˜åœ¨ä½¿ç”¨ThreadLocalçš„è¿‡ç¨‹ä¸­ä¼šå‘ç°æœ‰å†…å­˜æ³„æ¼çš„æƒ…å†µå‘ç”Ÿï¼Œå°±çŒœæµ‹è¿™ä¸ªå†…å­˜æ³„æ¼è·ŸEntryä¸­ä½¿ç”¨äº†å¼±å¼•ç”¨çš„keyæœ‰å…³ç³»ã€‚è¿™ä¸ªç†è§£å…¶å®æ˜¯ä¸å¯¹çš„ã€‚</p><p>â€‹	æˆ‘ä»¬å…ˆæ¥å›é¡¾è¿™ä¸ªé—®é¢˜ä¸­æ¶‰åŠçš„å‡ ä¸ªåè¯æ¦‚å¿µï¼Œå†æ¥åˆ†æé—®é¢˜ã€‚</p><p>   <strong>ï¼ˆ1ï¼‰ å†…å­˜æ³„æ¼ç›¸å…³æ¦‚å¿µ</strong></p><ul><li>Memory overflow:å†…å­˜æº¢å‡ºï¼Œæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æä¾›ç”³è¯·è€…ä½¿ç”¨ã€‚</li><li>Memory leak: å†…å­˜æ³„æ¼æ˜¯æŒ‡ç¨‹åºä¸­å·±åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› ç¨‹åºæœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œé€Ÿåº¦å‡æ…¢ç”šè‡³ç³»ç»Ÿå´©æºƒç­‰ä¸¥é‡åæœã€‚å†…å­˜æ³„æ¼çš„å †ç§¯ç»ˆå°†å¯¼è‡´å†…å­˜æº¢å‡ºã€‚	</li></ul><p><strong>ï¼ˆ2ï¼‰  å¼±å¼•ç”¨ç›¸å…³æ¦‚å¿µ</strong></p><p>â€‹	Javaä¸­çš„å¼•ç”¨æœ‰4ç§ç±»å‹ï¼š å¼ºã€è½¯ã€å¼±ã€è™šã€‚å½“å‰è¿™ä¸ªé—®é¢˜ä¸»è¦æ¶‰åŠåˆ°å¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨ï¼š</p><p>â€‹	<strong>å¼ºå¼•ç”¨ï¼ˆâ€œStrongâ€ Referenceï¼‰</strong>ï¼Œå°±æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œåªè¦è¿˜æœ‰å¼ºå¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå°±èƒ½è¡¨æ˜å¯¹è±¡è¿˜â€œæ´»ç€â€ï¼Œåƒåœ¾å›æ”¶å™¨å°±ä¸ä¼šå›æ”¶è¿™ç§å¯¹è±¡ã€‚</p><p>â€‹	<strong>å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰</strong>ï¼Œåƒåœ¾å›æ”¶å™¨ä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚</p><p><strong>ï¼ˆ3ï¼‰ å¦‚æœkeyä½¿ç”¨å¼ºå¼•ç”¨</strong></p><p>â€‹	å‡è®¾ThreadLocalMapä¸­çš„keyä½¿ç”¨äº†å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆä¼šå‡ºç°å†…å­˜æ³„æ¼å—ï¼Ÿ</p><p>â€‹	æ­¤æ—¶ThreadLocalçš„å†…å­˜å›¾ï¼ˆå®çº¿è¡¨ç¤ºå¼ºå¼•ç”¨ï¼‰å¦‚ä¸‹ï¼š </p><p><img alt="1582902708234" src="/richardgong1987-learn/assets/images/009-6e8b78b158a71b91f2bb6c7d39d9ac59.png"></p><p>â€‹	å‡è®¾åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨å®ŒThreadLocal ï¼ŒthreadLocal Refè¢«å›æ”¶äº†ã€‚</p><p>â€‹	ä½†æ˜¯å› ä¸ºthreadLocalMapçš„Entryå¼ºå¼•ç”¨äº†threadLocalï¼Œé€ æˆthreadLocalæ— æ³•è¢«å›æ”¶ã€‚</p><p>â€‹	åœ¨æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ªEntryä»¥åŠCurrentThreadä¾ç„¶è¿è¡Œçš„å‰æä¸‹ï¼Œå§‹ç»ˆæœ‰å¼ºå¼•ç”¨é“¾ threadRef-&gt;currentThread-&gt;threadLocalMap-&gt;entryï¼ŒEntryå°±ä¸ä¼šè¢«å›æ”¶ï¼ˆEntryä¸­åŒ…æ‹¬äº†ThreadLocalå®ä¾‹å’Œvalueï¼‰ï¼Œå¯¼è‡´Entryå†…å­˜æ³„æ¼ã€‚</p><p>â€‹	ä¹Ÿå°±æ˜¯è¯´ï¼ŒThreadLocalMapä¸­çš„keyä½¿ç”¨äº†å¼ºå¼•ç”¨ï¼Œ æ˜¯æ— æ³•å®Œå…¨é¿å…å†…å­˜æ³„æ¼çš„ã€‚</p><p><strong>ï¼ˆ5ï¼‰å¦‚æœkeyä½¿ç”¨å¼±å¼•ç”¨</strong></p><p>â€‹	é‚£ä¹ˆThreadLocalMapä¸­çš„keyä½¿ç”¨äº†å¼±å¼•ç”¨ï¼Œä¼šå‡ºç°å†…å­˜æ³„æ¼å—ï¼Ÿ</p><p>â€‹	æ­¤æ—¶ThreadLocalçš„å†…å­˜å›¾ï¼ˆå®çº¿è¡¨ç¤ºå¼ºå¼•ç”¨ï¼Œè™šçº¿è¡¨ç¤ºå¼±å¼•ç”¨ï¼‰å¦‚ä¸‹ï¼š </p><p><img alt="1582907143471" src="/richardgong1987-learn/assets/images/006-8f4acb712ce6ce325bdf8b9384a0f664.png"></p><p>â€‹	</p><p>â€‹	åŒæ ·å‡è®¾åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨å®ŒThreadLocal ï¼ŒthreadLocal Refè¢«å›æ”¶äº†ã€‚</p><p>â€‹	ç”±äºThreadLocalMapåªæŒæœ‰ThreadLocalçš„å¼±å¼•ç”¨ï¼Œæ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨æŒ‡å‘threadlocalå®ä¾‹, æ‰€ä»¥threadlocalå°±å¯ä»¥é¡ºåˆ©è¢«gcå›æ”¶ï¼Œæ­¤æ—¶Entryä¸­çš„key=nullã€‚</p><p>â€‹	ä½†æ˜¯åœ¨æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ªEntryä»¥åŠCurrentThreadä¾ç„¶è¿è¡Œçš„å‰æä¸‹ï¼Œä¹Ÿå­˜åœ¨æœ‰å¼ºå¼•ç”¨é“¾ threadRef-&gt;currentThread-&gt;threadLocalMap-&gt;entry -&gt; value ï¼Œvalueä¸ä¼šè¢«å›æ”¶ï¼Œ è€Œè¿™å—valueæ°¸è¿œä¸ä¼šè¢«è®¿é—®åˆ°äº†ï¼Œå¯¼è‡´valueå†…å­˜æ³„æ¼ã€‚</p><p>â€‹	ä¹Ÿå°±æ˜¯è¯´ï¼ŒThreadLocalMapä¸­çš„keyä½¿ç”¨äº†å¼±å¼•ç”¨ï¼Œ ä¹Ÿæœ‰å¯èƒ½å†…å­˜æ³„æ¼ã€‚</p><p><strong>ï¼ˆ6ï¼‰å‡ºç°å†…å­˜æ³„æ¼çš„çœŸå®åŸå› </strong></p><p>â€‹	æ¯”è¾ƒä»¥ä¸Šä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬å°±ä¼šå‘ç°ï¼Œå†…å­˜æ³„æ¼çš„å‘ç”Ÿè·ŸThreadLocalMapä¸­çš„keyæ˜¯å¦ä½¿ç”¨å¼±å¼•ç”¨æ˜¯æ²¡æœ‰å…³ç³»çš„ã€‚é‚£ä¹ˆå†…å­˜æ³„æ¼çš„çš„çœŸæ­£åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>â€‹	ç»†å¿ƒçš„åŒå­¦ä¼šå‘ç°ï¼Œåœ¨ä»¥ä¸Šä¸¤ç§å†…å­˜æ³„æ¼çš„æƒ…å†µä¸­ï¼Œéƒ½æœ‰ä¸¤ä¸ªå‰æï¼š</p><ol><li>æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ªEntry</li><li>CurrentThreadä¾ç„¶è¿è¡Œ</li></ol><p>â€‹        ç¬¬ä¸€ç‚¹å¾ˆå¥½ç†è§£ï¼Œåªè¦åœ¨ä½¿ç”¨å®ŒThreadLocalï¼Œè°ƒç”¨å…¶removeæ–¹æ³•åˆ é™¤å¯¹åº”çš„Entryï¼Œå°±èƒ½é¿å…å†…å­˜æ³„æ¼ã€‚</p><p>â€‹	ç¬¬äºŒç‚¹ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œ ç”±äºThreadLocalMapæ˜¯Threadçš„ä¸€ä¸ªå±æ€§ï¼Œè¢«å½“å‰çº¿ç¨‹æ‰€å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒçš„ç”Ÿå‘½å‘¨æœŸè·ŸThreadä¸€æ ·é•¿ã€‚é‚£ä¹ˆåœ¨ä½¿ç”¨å®ŒThreadLocalçš„ä½¿ç”¨ï¼Œå¦‚æœå½“å‰Threadä¹Ÿéšä¹‹æ‰§è¡Œç»“æŸï¼ŒThreadLocalMapè‡ªç„¶ä¹Ÿä¼šè¢«gcå›æ”¶ï¼Œä»æ ¹æºä¸Šé¿å…äº†å†…å­˜æ³„æ¼ã€‚</p><p>â€‹	ç»¼ä¸Šï¼Œ<strong>ThreadLocalå†…å­˜æ³„æ¼çš„æ ¹æºæ˜¯</strong>ï¼šç”±äºThreadLocalMapçš„ç”Ÿå‘½å‘¨æœŸè·ŸThreadä¸€æ ·é•¿ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº”keyå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p><strong>ï¼ˆ7ï¼‰ ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨</strong></p><p>â€‹	æ ¹æ®åˆšæ‰çš„åˆ†æ, æˆ‘ä»¬çŸ¥é“äº†ï¼š æ— è®ºThreadLocalMapä¸­çš„keyä½¿ç”¨å“ªç§ç±»å‹å¼•ç”¨éƒ½æ— æ³•å®Œå…¨é¿å…å†…å­˜æ³„æ¼ï¼Œè·Ÿä½¿ç”¨å¼±å¼•ç”¨æ²¡æœ‰å…³ç³»ã€‚</p><p>â€‹	è¦é¿å…å†…å­˜æ³„æ¼æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li><p>ä½¿ç”¨å®ŒThreadLocalï¼Œè°ƒç”¨å…¶removeæ–¹æ³•åˆ é™¤å¯¹åº”çš„Entry</p></li><li><p>ä½¿ç”¨å®ŒThreadLocalï¼Œå½“å‰Threadä¹Ÿéšä¹‹è¿è¡Œç»“æŸ</p></li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">ç›¸å¯¹ç¬¬ä¸€ç§æ–¹å¼ï¼Œç¬¬äºŒç§æ–¹å¼æ˜¾ç„¶æ›´ä¸å¥½æ§åˆ¶ï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œçº¿ç¨‹ç»“æŸæ˜¯ä¸ä¼šé”€æ¯çš„ã€‚</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦è®°å¾—åœ¨ä½¿ç”¨å®ŒThreadLocalåŠæ—¶çš„è°ƒç”¨removeï¼Œæ— è®ºkeyæ˜¯å¼ºå¼•ç”¨è¿˜æ˜¯å¼±å¼•ç”¨éƒ½ä¸ä¼šæœ‰é—®é¢˜ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆkeyè¦ç”¨å¼±å¼•ç”¨å‘¢ï¼Ÿ</p><p>â€‹	äº‹å®ä¸Šï¼Œåœ¨ThreadLocalMapä¸­çš„set/getEntryæ–¹æ³•ä¸­ï¼Œä¼šå¯¹keyä¸ºnullï¼ˆä¹Ÿå³æ˜¯ThreadLocalä¸ºnullï¼‰è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸ºnullçš„è¯ï¼Œé‚£ä¹ˆæ˜¯ä¼šå¯¹valueç½®ä¸ºnullçš„ã€‚</p><p>â€‹	è¿™å°±æ„å‘³ç€ä½¿ç”¨å®ŒThreadLocalï¼ŒCurrentThreadä¾ç„¶è¿è¡Œçš„å‰æä¸‹ï¼Œå°±ç®—å¿˜è®°è°ƒç”¨removeæ–¹æ³•ï¼Œ<strong>å¼±å¼•ç”¨æ¯”å¼ºå¼•ç”¨å¯ä»¥å¤šä¸€å±‚ä¿éšœ</strong>ï¼šå¼±å¼•ç”¨çš„ThreadLocalä¼šè¢«å›æ”¶ï¼Œå¯¹åº”çš„valueåœ¨ä¸‹ä¸€æ¬¡ThreadLocalMapè°ƒç”¨set,get,removeä¸­çš„ä»»ä¸€æ–¹æ³•çš„æ—¶å€™ä¼šè¢«æ¸…é™¤ï¼Œä»è€Œé¿å…å†…å­˜æ³„æ¼ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="53-hashå†²çªçš„è§£å†³"></a>5.3 hashå†²çªçš„è§£å†³<a class="hash-link" href="#53-hashå†²çªçš„è§£å†³" title="Direct link to heading">#</a></h3><p>â€‹	hashå†²çªçš„è§£å†³æ˜¯Mapä¸­çš„ä¸€ä¸ªé‡è¦å†…å®¹ã€‚æˆ‘ä»¬ä»¥hashå†²çªçš„è§£å†³ä¸ºçº¿ç´¢ï¼Œæ¥ç ”ç©¶ä¸€ä¸‹ThreadLocalMapçš„æ ¸å¿ƒæºç ã€‚</p><p><strong>ï¼ˆ1ï¼‰ é¦–å…ˆä»ThreadLocalçš„set() æ–¹æ³•å…¥æ‰‹</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  public void set(T value) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Thread t = Thread.currentThread();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadLocal.ThreadLocalMap map = getMap(t);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (map != null)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //è°ƒç”¨äº†ThreadLocalMapçš„setæ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.set(this, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            createMap(t, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ThreadLocal.ThreadLocalMap getMap(Thread t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return t.threadLocals;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void createMap(Thread t, T firstValue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //è°ƒç”¨äº†ThreadLocalMapçš„æ„é€ æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        t.threadLocals = new ThreadLocal.ThreadLocalMap(this, firstValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åˆšæ‰åˆ†æè¿‡, å…¶ä½œç”¨æ˜¯è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡ : </p><p>â€‹	A. é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ªMap</p><p>â€‹	B. å¦‚æœè·å–çš„Mapä¸ä¸ºç©ºï¼Œåˆ™å°†å‚æ•°è®¾ç½®åˆ°Mapä¸­ï¼ˆå½“å‰ThreadLocalçš„å¼•ç”¨ä½œä¸ºkeyï¼‰</p><p>â€‹		<strong>(è¿™é‡Œè°ƒç”¨äº†ThreadLocalMapçš„setæ–¹æ³•)</strong></p><p>â€‹	C. å¦‚æœMapä¸ºç©ºï¼Œåˆ™ç»™è¯¥çº¿ç¨‹åˆ›å»º Mapï¼Œå¹¶è®¾ç½®åˆå§‹å€¼</p><p>â€‹		<strong>(è¿™é‡Œè°ƒç”¨äº†ThreadLocalMapçš„æ„é€ æ–¹æ³•)</strong></p><p>è¿™æ®µä»£ç æœ‰ä¸¤ä¸ªåœ°æ–¹åˆ†åˆ«æ¶‰åŠåˆ°ThreadLocalMapçš„ä¸¤ä¸ªæ–¹æ³•, æˆ‘ä»¬æ¥ç€åˆ†æè¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p><p><strong>ï¼ˆ2ï¼‰æ„é€ æ–¹æ³•`ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue)</strong>`</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> /*</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * firstKey : æœ¬ThreadLocalå®ä¾‹(this)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  * firstValue ï¼š è¦ä¿å­˜çš„çº¿ç¨‹æœ¬åœ°å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //åˆå§‹åŒ–table</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        table = new ThreadLocal.ThreadLocalMap.Entry[INITIAL_CAPACITY];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è®¡ç®—ç´¢å¼•(é‡ç‚¹ä»£ç ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è®¾ç½®å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        table[i] = new ThreadLocal.ThreadLocalMap.Entry(firstKey, firstValue);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è®¾ç½®é˜ˆå€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        setThreshold(INITIAL_CAPACITY);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	æ„é€ å‡½æ•°é¦–å…ˆåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º16çš„Entryæ•°ç»„ï¼Œç„¶åè®¡ç®—å‡ºfirstKeyå¯¹åº”çš„ç´¢å¼•ï¼Œç„¶åå­˜å‚¨åˆ°tableä¸­ï¼Œå¹¶è®¾ç½®sizeå’Œthresholdã€‚</p><p>â€‹	<strong>é‡ç‚¹åˆ†æ</strong>ï¼š <code>int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1)</code>ã€‚</p><p>a. å…³äº<code>firstKey.threadLocalHashCode</code>ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    private final int threadLocalHashCode = nextHashCode();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static int nextHashCode() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nextHashCode.getAndAdd(HASH_INCREMENT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//AtomicIntegeræ˜¯ä¸€ä¸ªæä¾›åŸå­æ“ä½œçš„Integerç±»ï¼Œé€šè¿‡çº¿ç¨‹å®‰å…¨çš„æ–¹å¼æ“ä½œåŠ å‡,é€‚åˆé«˜å¹¶å‘æƒ…å†µä¸‹çš„ä½¿ç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static AtomicInteger nextHashCode =  new AtomicInteger();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     //ç‰¹æ®Šçš„hashå€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int HASH_INCREMENT = 0x61c88647;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªAtomicIntegerç±»å‹ï¼Œæ¯æ¬¡è·å–å½“å‰å€¼å¹¶åŠ ä¸ŠHASH_INCREMENTï¼Œ<code>HASH_INCREMENT = 0x61c88647</code>,è¿™ä¸ªå€¼è·Ÿæ–æ³¢é‚£å¥‘æ•°åˆ—ï¼ˆé»„é‡‘åˆ†å‰²æ•°ï¼‰æœ‰å…³ï¼Œå…¶ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†è®©å“ˆå¸Œç èƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨2çš„næ¬¡æ–¹çš„æ•°ç»„é‡Œ, ä¹Ÿå°±æ˜¯Entry[] tableä¸­ï¼Œè¿™æ ·åšå¯ä»¥å°½é‡é¿å…hashå†²çªã€‚</p><p>b. å…³äº<code>&amp; (INITIAL_CAPACITY - 1)</code></p><p>â€‹	è®¡ç®—hashçš„æ—¶å€™é‡Œé¢é‡‡ç”¨äº†hashCode &amp; (size - 1)çš„ç®—æ³•ï¼Œè¿™ç›¸å½“äºå–æ¨¡è¿ç®—hashCode % sizeçš„ä¸€ä¸ªæ›´é«˜æ•ˆçš„å®ç°ã€‚æ­£æ˜¯å› ä¸ºè¿™ç§ç®—æ³•ï¼Œæˆ‘ä»¬è¦æ±‚sizeå¿…é¡»æ˜¯2çš„æ•´æ¬¡å¹‚ï¼Œè¿™ä¹Ÿèƒ½ä¿è¯åœ¨ç´¢å¼•ä¸è¶Šç•Œçš„å‰æä¸‹ï¼Œä½¿å¾—hashå‘ç”Ÿå†²çªçš„æ¬¡æ•°å‡å°ã€‚</p><p><strong>ï¼ˆ3ï¼‰ ThreadLocalMapä¸­çš„setæ–¹æ³•</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">private void set(ThreadLocal&lt;?&gt; key, Object value) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ThreadLocal.ThreadLocalMap.Entry[] tab = table;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int len = tab.length;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è®¡ç®—ç´¢å¼•(é‡ç‚¹ä»£ç ï¼Œåˆšæ‰åˆ†æè¿‡äº†ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int i = key.threadLocalHashCode &amp; (len-1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * ä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•æŸ¥æ‰¾å…ƒç´ ï¼ˆé‡ç‚¹ä»£ç ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ThreadLocal.ThreadLocalMap.Entry e = tab[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             e != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             e = tab[i = nextIndex(i, len)]) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ThreadLocal&lt;?&gt; k = e.get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //ThreadLocal å¯¹åº”çš„ key å­˜åœ¨ï¼Œç›´æ¥è¦†ç›–ä¹‹å‰çš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (k == key) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                e.value = value;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // keyä¸º nullï¼Œä½†æ˜¯å€¼ä¸ä¸º nullï¼Œè¯´æ˜ä¹‹å‰çš„ ThreadLocal å¯¹è±¡å·²ç»è¢«å›æ”¶äº†ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">           // å½“å‰æ•°ç»„ä¸­çš„ Entry æ˜¯ä¸€ä¸ªé™ˆæ—§ï¼ˆstaleï¼‰çš„å…ƒç´ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (k == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //ç”¨æ–°å…ƒç´ æ›¿æ¢é™ˆæ—§çš„å…ƒç´ ï¼Œè¿™ä¸ªæ–¹æ³•è¿›è¡Œäº†ä¸å°‘çš„åƒåœ¾æ¸…ç†åŠ¨ä½œï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                replaceStaleEntry(key, value, i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ThreadLocalå¯¹åº”çš„keyä¸å­˜åœ¨å¹¶ä¸”æ²¡æœ‰æ‰¾åˆ°é™ˆæ—§çš„å…ƒç´ ï¼Œåˆ™åœ¨ç©ºå…ƒç´ çš„ä½ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„Entryã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            tab[i] = new Entry(key, value);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int sz = ++size;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             * cleanSomeSlotsç”¨äºæ¸…é™¤é‚£äº›e.get()==nullçš„å…ƒç´ ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             * è¿™ç§æ•°æ®keyå…³è”çš„å¯¹è±¡å·²ç»è¢«å›æ”¶ï¼Œæ‰€ä»¥è¿™ä¸ªEntry(table[index])å¯ä»¥è¢«ç½®nullã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             * å¦‚æœæ²¡æœ‰æ¸…é™¤ä»»ä½•entry,å¹¶ä¸”å½“å‰ä½¿ç”¨é‡è¾¾åˆ°äº†è´Ÿè½½å› å­æ‰€å®šä¹‰(é•¿åº¦çš„2/3)ï¼Œé‚£ä¹ˆè¿›è¡Œ              * rehashï¼ˆæ‰§è¡Œä¸€æ¬¡å…¨è¡¨çš„æ‰«ææ¸…ç†å·¥ä½œï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">             */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                rehash();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è·å–ç¯å½¢æ•°ç»„çš„ä¸‹ä¸€ä¸ªç´¢å¼•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static int nextIndex(int i, int len) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ((i + 1 &lt; len) ? i + 1 : 0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>â€‹	ä»£ç æ‰§è¡Œæµç¨‹ï¼š</p><p>A. é¦–å…ˆè¿˜æ˜¯æ ¹æ®keyè®¡ç®—å‡ºç´¢å¼• iï¼Œç„¶åæŸ¥æ‰¾iä½ç½®ä¸Šçš„Entryï¼Œ</p><p>B. è‹¥æ˜¯Entryå·²ç»å­˜åœ¨å¹¶ä¸”keyç­‰äºä¼ å…¥çš„keyï¼Œé‚£ä¹ˆè¿™æ—¶å€™ç›´æ¥ç»™è¿™ä¸ªEntryèµ‹æ–°çš„valueå€¼,</p><p>C. è‹¥æ˜¯Entryå­˜åœ¨ï¼Œä½†æ˜¯keyä¸ºnullï¼Œåˆ™è°ƒç”¨replaceStaleEntryæ¥æ›´æ¢è¿™ä¸ªkeyä¸ºç©ºçš„Entry,</p><p>D. ä¸æ–­å¾ªç¯æ£€æµ‹ï¼Œç›´åˆ°é‡åˆ°ä¸ºnullçš„åœ°æ–¹ï¼Œè¿™æ—¶å€™è¦æ˜¯è¿˜æ²¡åœ¨å¾ªç¯è¿‡ç¨‹ä¸­returnï¼Œé‚£ä¹ˆå°±åœ¨è¿™ä¸ªnullçš„ä½ç½®æ–°å»ºä¸€ä¸ªEntryï¼Œå¹¶ä¸”æ’å…¥ï¼ŒåŒæ—¶sizeå¢åŠ 1ã€‚</p><p>â€‹    æœ€åè°ƒç”¨cleanSomeSlotsï¼Œæ¸…ç†keyä¸ºnullçš„Entryï¼Œæœ€åè¿”å›æ˜¯å¦æ¸…ç†äº†Entryï¼Œæ¥ä¸‹æ¥å†åˆ¤æ–­sz æ˜¯å¦&gt;= thresgoldè¾¾åˆ°äº†rehashçš„æ¡ä»¶ï¼Œè¾¾åˆ°çš„è¯å°±ä¼šè°ƒç”¨rehashå‡½æ•°æ‰§è¡Œä¸€æ¬¡å…¨è¡¨çš„æ‰«ææ¸…ç†ã€‚</p><p><strong>é‡ç‚¹åˆ†æ</strong> ï¼š ThreadLocalMapä½¿ç”¨<code>çº¿æ€§æ¢æµ‹æ³•</code>æ¥è§£å†³å“ˆå¸Œå†²çªçš„ã€‚</p><p>â€‹	è¯¥æ–¹æ³•ä¸€æ¬¡æ¢æµ‹ä¸‹ä¸€ä¸ªåœ°å€ï¼Œç›´åˆ°æœ‰ç©ºçš„åœ°å€åæ’å…¥ï¼Œè‹¥æ•´ä¸ªç©ºé—´éƒ½æ‰¾ä¸åˆ°ç©ºä½™çš„åœ°å€ï¼Œåˆ™äº§ç”Ÿæº¢å‡ºã€‚</p><p>â€‹	ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾å½“å‰tableé•¿åº¦ä¸º16ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœè®¡ç®—å‡ºæ¥keyçš„hashå€¼ä¸º14ï¼Œå¦‚æœtable[14]ä¸Šå·²ç»æœ‰å€¼ï¼Œå¹¶ä¸”å…¶keyä¸å½“å‰keyä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±å‘ç”Ÿäº†hashå†²çªï¼Œè¿™ä¸ªæ—¶å€™å°†14åŠ 1å¾—åˆ°15ï¼Œå–table[15]è¿›è¡Œåˆ¤æ–­ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¿˜æ˜¯å†²çªä¼šå›åˆ°0ï¼Œå–table[0],ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°å¯ä»¥æ’å…¥ã€‚</p><p>â€‹	æŒ‰ç…§ä¸Šé¢çš„æè¿°ï¼Œå¯ä»¥æŠŠEntry[]  tableçœ‹æˆä¸€ä¸ªç¯å½¢æ•°ç»„ã€‚</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/richardgong1987-learn/richardgong1987-learn/edit/master/website/docs/a-java/a-java-concurrent/threadlocal.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/richardgong1987-learn/docs/a-java/a-java-concurrent/nio"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« NIOã€ç½‘ç»œç¼–ç¨‹å’Œã€‘</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/richardgong1987-learn/docs/a-java/a-java-concurrent/threadpool/readme"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">çº¿ç¨‹æ±  Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-threadlocalä»‹ç»" class="table-of-contents__link">1. ThreadLocalä»‹ç»</a><ul><li><a href="#11-å®˜æ–¹ä»‹ç»" class="table-of-contents__link">1.1 å®˜æ–¹ä»‹ç»</a></li><li><a href="#12-åŸºæœ¬ä½¿ç”¨" class="table-of-contents__link">1.2 åŸºæœ¬ä½¿ç”¨</a></li><li><a href="#13-threadlocalç±»ä¸synchronizedå…³é”®å­—" class="table-of-contents__link">1.3 ThreadLocalç±»ä¸synchronizedå…³é”®å­—</a></li></ul></li><li><a href="#2-è¿ç”¨åœºæ™¯_äº‹åŠ¡æ¡ˆä¾‹" class="table-of-contents__link">2. è¿ç”¨åœºæ™¯_äº‹åŠ¡æ¡ˆä¾‹</a><ul><li><a href="#21-è½¬è´¦æ¡ˆä¾‹" class="table-of-contents__link">2.1 è½¬è´¦æ¡ˆä¾‹</a></li><li><a href="#22--å¸¸è§„è§£å†³æ–¹æ¡ˆ" class="table-of-contents__link">2.2  å¸¸è§„è§£å†³æ–¹æ¡ˆ</a></li><li><a href="#23-threadlocalè§£å†³æ–¹æ¡ˆ" class="table-of-contents__link">2.3 ThreadLocalè§£å†³æ–¹æ¡ˆ</a></li></ul></li><li><a href="#3-threadlocalçš„å†…éƒ¨ç»“æ„" class="table-of-contents__link">3. ThreadLocalçš„å†…éƒ¨ç»“æ„</a><ul><li><a href="#31--å¸¸è§çš„è¯¯è§£" class="table-of-contents__link">3.1  å¸¸è§çš„è¯¯è§£</a></li><li><a href="#32--ç°åœ¨çš„è®¾è®¡" class="table-of-contents__link">3.2  ç°åœ¨çš„è®¾è®¡</a></li><li><a href="#33-è¿™æ ·è®¾è®¡çš„å¥½å¤„" class="table-of-contents__link">3.3 è¿™æ ·è®¾è®¡çš„å¥½å¤„</a></li></ul></li><li><a href="#4-threadlocalçš„æ ¸å¿ƒæ–¹æ³•æºç " class="table-of-contents__link">4. ThreadLocalçš„æ ¸å¿ƒæ–¹æ³•æºç </a><ul><li><a href="#41-setæ–¹æ³•" class="table-of-contents__link">4.1 setæ–¹æ³•</a></li><li><a href="#42-getæ–¹æ³•" class="table-of-contents__link">4.2 getæ–¹æ³•</a></li><li><a href="#43-removeæ–¹æ³•" class="table-of-contents__link">4.3 removeæ–¹æ³•</a></li><li><a href="#44-initialvalueæ–¹æ³•" class="table-of-contents__link"><strong>4.4 initialValueæ–¹æ³•</strong></a></li></ul></li><li><a href="#5-threadlocalmapæºç åˆ†æ" class="table-of-contents__link">5. ThreadLocalMapæºç åˆ†æ</a><ul><li><a href="#51-åŸºæœ¬ç»“æ„" class="table-of-contents__link">5.1 åŸºæœ¬ç»“æ„</a></li><li><a href="#52-å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼" class="table-of-contents__link">5.2 å¼±å¼•ç”¨å’Œå†…å­˜æ³„æ¼</a></li><li><a href="#53-hashå†²çªçš„è§£å†³" class="table-of-contents__link">5.3 hashå†²çªçš„è§£å†³</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/richardgong1987-learn/assets/js/runtime~main.355ae127.js"></script>
<script src="/richardgong1987-learn/assets/js/main.e4c628bc.js"></script>
</body>
</html>